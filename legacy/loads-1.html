<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Load Management - ATS FREIGHT LLC</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/js/all.min.js"></script>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700;800;900&display=swap"
        rel="stylesheet">
    <!-- Mobile Responsiveness -->
    <link rel="stylesheet" href="mobile-fixes.css">
    <script src="mobile-nav.js" defer></script>
    <style>
        body {
            font-family: 'Inter', sans-serif;
        }

        .bg-navy {
            background-color: #1f2937;
        }

        .text-navy {
            color: #1f2937;
        }

        .gradient-bg {
            background-color: #1f2937;
        }

        .card-shadow {
            box-shadow: 0 4px 6px -1px rgba(0, 0, 0, 0.1), 0 2px 4px -1px rgba(0, 0, 0, 0.06);
        }

        .status-available {
            background-color: #6b7280;
        }

        .status-dispatched {
            background-color: #f59e0b;
        }

        .status-in-transit {
            background-color: #3b82f6;
        }

        .status-delivered {
            background-color: #10b981;
        }

        .status-cancelled {
            background-color: #ef4444;
        }

        .nav-item {
            transition: all 0.2s ease;
        }

        .nav-item:hover {
            background-color: rgba(255, 255, 255, 0.1);
        }

        .nav-item.active {
            background-color: rgba(255, 255, 255, 0.1);
        }

        .modal {
            display: none;
            position: fixed;
            z-index: 1000;
            left: 0;
            top: 0;
            width: 100%;
            height: 100%;
            background-color: rgba(0, 0, 0, 0.5);
        }

        .modal.show {
            display: flex;
            align-items: center;
            justify-content: center;
        }

        .modal-content {
            background-color: white;
            margin: auto;
            padding: 0;
            border-radius: 12px;
            width: 90%;
            max-width: 800px;
            max-height: 90vh;
            overflow-y: auto;
        }
    </style>
</head>

<body class="bg-gray-50">
    <!-- Navigation -->
    <nav class="gradient-bg text-white shadow-lg">
        <div class="max-w-7xl mx-auto px-4 sm:px-6 lg:px-8">
            <div class="flex justify-between items-center h-16">
                <div class="flex items-center space-x-4">
                    <img src="resources/ats-freight-logo.png" alt="ATS FREIGHT LLC" class="h-12 w-12 object-contain"
                        onerror="this.classList.add('hidden'); this.nextElementSibling.classList.remove('hidden'); this.nextElementSibling.classList.add('flex');">
                    <div
                        class="company-logo hidden w-12 h-12 bg-white rounded-lg items-center justify-center font-bold text-gray-800">
                        ATS</div>
                    <div>
                        <h1 class="text-xl font-bold">ATS FREIGHT LLC</h1>
                        <p class="text-sm opacity-90">Transportation Management System</p>
                    </div>
                </div>
                <div class="flex items-center space-x-6">
                    <a href="index.html" class="nav-item px-3 py-2 rounded-md text-sm font-medium">
                        <i class="fas fa-tachometer-alt mr-2"></i>Dashboard
                    </a>
                    <span class="nav-item active px-3 py-2 rounded-md text-sm font-medium">
                        <i class="fas fa-truck mr-2"></i>Loads
                    </span>
                    <a href="drivers.html" class="nav-item px-3 py-2 rounded-md text-sm font-medium">
                        <i class="fas fa-users mr-2"></i>Drivers
                    </a>
                    <span class="text-sm">Welcome, Liban Ali</span>
                    <button class="nav-item px-3 py-2 rounded-md text-sm font-medium">
                        <i class="fas fa-sign-out-alt mr-2"></i>Logout
                    </button>
                </div>
            </div>
        </div>
    </nav>

    <!-- Main Content -->
    <div class="max-w-7xl mx-auto px-4 sm:px-6 lg:px-8 py-8">
        <!-- Page Header -->
        <div class="flex justify-between items-center mb-8">
            <div>
                <h2 class="text-3xl font-bold text-gray-900">Load Management</h2>
                <p class="text-gray-600 mt-2">Manage all freight loads and shipments</p>
            </div>
            <button onclick="openCreateLoadModal()"
                class="bg-blue-600 text-white px-6 py-3 rounded-lg hover:bg-blue-700 transition-colors">
                <i class="fas fa-plus mr-2"></i>Create New Load
            </button>
        </div>

        <!-- Filters and Search -->
        <div class="bg-white rounded-lg p-6 card-shadow mb-8">
            <div class="grid grid-cols-1 md:grid-cols-4 gap-4">
                <div>
                    <label for="statusFilter" class="block text-sm font-medium text-gray-700 mb-2">Status</label>
                    <select id="statusFilter" aria-label="Filter by Status"
                        class="w-full border border-gray-300 rounded-lg px-3 py-2 focus:ring-2 focus:ring-blue-500 focus:border-transparent">
                        <option value="">All Statuses</option>
                        <option value="available">Available</option>
                        <option value="dispatched">Dispatched</option>
                        <option value="in_transit">In Transit</option>
                        <option value="delivered">Delivered</option>
                        <option value="cancelled">Cancelled</option>
                    </select>
                </div>
                <div>
                    <label for="driverFilter" class="block text-sm font-medium text-gray-700 mb-2">Driver</label>
                    <select id="driverFilter" aria-label="Filter by Driver"
                        class="w-full border border-gray-300 rounded-lg px-3 py-2 focus:ring-2 focus:ring-blue-500 focus:border-transparent">
                        <option value="">All Drivers</option>
                    </select>
                </div>
                <div>
                    <label for="customerFilter" class="block text-sm font-medium text-gray-700 mb-2">Customer</label>
                    <select id="customerFilter" aria-label="Filter by Customer"
                        class="w-full border border-gray-300 rounded-lg px-3 py-2 focus:ring-2 focus:ring-blue-500 focus:border-transparent">
                        <option value="">All Customers</option>
                    </select>
                </div>
                <div>
                    <label for="searchInput" class="block text-sm font-medium text-gray-700 mb-2">Search</label>
                    <input type="text" id="searchInput" placeholder="Load #, origin, destination..."
                        class="w-full border border-gray-300 rounded-lg px-3 py-2 focus:ring-2 focus:ring-blue-500 focus:border-transparent">
                </div>
            </div>
        </div>

        <!-- Loads Table -->
        <div class="bg-white rounded-lg card-shadow">
            <div class="px-6 py-4 border-b border-gray-200">
                <div class="flex justify-between items-center">
                    <h3 class="text-lg font-semibold text-gray-900">All Loads</h3>
                    <div class="flex items-center space-x-4">
                        <button class="text-gray-600 hover:text-gray-800">
                            <i class="fas fa-download mr-2"></i>Export
                        </button>
                        <button class="text-gray-600 hover:text-gray-800">
                            <i class="fas fa-filter mr-2"></i>Filter
                        </button>
                    </div>
                </div>
            </div>
            <div class="overflow-x-auto table-responsive table-scroll-hint">
                <table class="min-w-full divide-y divide-gray-200">
                    <thead class="bg-gray-50">
                        <tr>
                            <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">
                                Load #</th>
                            <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">
                                Origin → Destination</th>
                            <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">
                                Customer</th>
                            <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">
                                Driver</th>
                            <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">
                                Rate</th>
                            <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">
                                Status</th>
                            <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">
                                Actions</th>
                        </tr>
                    </thead>
                    <tbody id="loadsTableBody" class="bg-white divide-y divide-gray-200">
                        <!-- Loads data will be populated from Firebase -->
                    </tbody>
                </table>
            </div>
            <div class="px-6 py-4 border-t border-gray-200">
                <div class="flex items-center justify-between">
                    <div class="text-sm text-gray-700">
                        Showing <span class="font-medium">1</span> to <span class="font-medium">4</span> of <span
                            class="font-medium">24</span> loads
                    </div>
                    <div class="flex space-x-2">
                        <button
                            class="px-3 py-2 text-sm font-medium text-gray-500 bg-white border border-gray-300 rounded-md hover:bg-gray-50">
                            Previous
                        </button>
                        <button
                            class="px-3 py-2 text-sm font-medium text-white bg-blue-600 border border-transparent rounded-md">
                            1
                        </button>
                        <button
                            class="px-3 py-2 text-sm font-medium text-gray-500 bg-white border border-gray-300 rounded-md hover:bg-gray-50">
                            2
                        </button>
                        <button
                            class="px-3 py-2 text-sm font-medium text-gray-500 bg-white border border-gray-300 rounded-md hover:bg-gray-50">
                            3
                        </button>
                        <button
                            class="px-3 py-2 text-sm font-medium text-gray-500 bg-white border border-gray-300 rounded-md hover:bg-gray-50">
                            Next
                        </button>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Create/Edit Load Modal -->
    <div id="loadModal" class="modal">
        <div class="modal-content">
            <div class="bg-gradient-to-r from-blue-600 to-blue-800 text-white px-6 py-4">
                <div class="flex justify-between items-center">
                    <h3 id="modalTitle" class="text-xl font-semibold">Create New Load</h3>
                    <button onclick="closeModal()" class="text-white hover:text-gray-200" aria-label="Close Modal">
                        <i class="fas fa-times text-xl"></i>
                    </button>
                </div>
            </div>

            <div class="p-6">
                <form id="loadForm" class="space-y-6">
                    <!-- Rate Confirmation Upload -->
                    <div class="bg-blue-50 border border-blue-200 rounded-lg p-4 mb-6">
                        <div class="flex items-center justify-between mb-2">
                            <h4 class="text-sm font-semibold text-blue-900 flex items-center">
                                <i class="fas fa-file-upload mr-2"></i>
                                Upload Rate Confirmation (Optional)
                            </h4>
                            <button type="button" onclick="clearConfirmationUpload()"
                                class="text-xs text-blue-600 hover:text-blue-800 hidden" id="clearUploadBtn">
                                <i class="fas fa-times mr-1"></i>Clear
                            </button>
                        </div>
                        <p class="text-xs text-blue-700 mb-3">Upload a rate confirmation document (PDF or image) to
                            automatically populate load information</p>
                        <div class="flex items-center space-x-4">
                            <label for="confirmationUpload"
                                class="cursor-pointer bg-blue-600 text-white px-4 py-2 rounded-lg hover:bg-blue-700 transition-colors text-sm">
                                <i class="fas fa-upload mr-2"></i>Choose File
                            </label>
                            <input type="file" id="confirmationUpload" accept=".pdf,.png,.jpg,.jpeg" class="hidden"
                                onchange="handleConfirmationUpload(event)">
                            <span id="uploadFileName" class="text-sm text-gray-600"></span>
                            <div id="uploadProgress" class="hidden flex items-center text-sm text-blue-600">
                                <i class="fas fa-spinner fa-spin mr-2"></i>
                                <span>Processing...</span>
                            </div>
                        </div>
                    </div>

                    <!-- Load Information -->
                    <div class="grid grid-cols-1 md:grid-cols-2 gap-6">
                        <div>
                            <label class="block text-sm font-medium text-gray-700 mb-2">Load Number</label>
                            <input type="text" id="loadNumber"
                                class="w-full border border-gray-300 rounded-lg px-3 py-2 focus:ring-2 focus:ring-blue-500 focus:border-transparent"
                                placeholder="Somali Truck-2025-005">
                        </div>
                        <div>
                            <label class="block text-sm font-medium text-gray-700 mb-2">Status</label>
                            <select id="loadStatus"
                                class="w-full border border-gray-300 rounded-lg px-3 py-2 focus:ring-2 focus:ring-blue-500 focus:border-transparent">
                                <option value="available">Available</option>
                                <option value="dispatched">Dispatched</option>
                                <option value="in_transit">In Transit</option>
                                <option value="delivered">Delivered</option>
                                <option value="cancelled">Cancelled</option>
                            </select>
                        </div>
                    </div>

                    <!-- Customer Information -->
                    <div>
                        <label class="block text-sm font-medium text-gray-700 mb-2">Customer</label>
                        <select id="customer"
                            class="w-full border border-gray-300 rounded-lg px-3 py-2 focus:ring-2 focus:ring-blue-500 focus:border-transparent">
                            <option value="">Select Customer</option>
                        </select>
                    </div>

                    <!-- Pickup Information -->
                    <div class="border-t pt-6">
                        <h4 class="text-lg font-semibold text-gray-900 mb-4">Pickup Information</h4>
                        <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
                            <div>
                                <label class="block text-sm font-medium text-gray-700 mb-2">Pickup Address</label>
                                <input type="text" id="pickupAddress"
                                    class="w-full border border-gray-300 rounded-lg px-3 py-2 focus:ring-2 focus:ring-blue-500 focus:border-transparent"
                                    placeholder="123 Main St">
                            </div>
                            <div>
                                <label class="block text-sm font-medium text-gray-700 mb-2">City</label>
                                <input type="text" id="pickupCity"
                                    class="w-full border border-gray-300 rounded-lg px-3 py-2 focus:ring-2 focus:ring-blue-500 focus:border-transparent"
                                    placeholder="Columbus">
                            </div>
                            <div>
                                <label class="block text-sm font-medium text-gray-700 mb-2">State</label>
                                <select id="pickupState"
                                    class="w-full border border-gray-300 rounded-lg px-3 py-2 focus:ring-2 focus:ring-blue-500 focus:border-transparent">
                                    <option value="">Select State</option>
                                    <option value="AL">Alabama</option>
                                    <option value="AK">Alaska</option>
                                    <option value="AZ">Arizona</option>
                                    <option value="AR">Arkansas</option>
                                    <option value="CA">California</option>
                                    <option value="CO">Colorado</option>
                                    <option value="CT">Connecticut</option>
                                    <option value="DE">Delaware</option>
                                    <option value="FL">Florida</option>
                                    <option value="GA">Georgia</option>
                                    <option value="HI">Hawaii</option>
                                    <option value="ID">Idaho</option>
                                    <option value="IL">Illinois</option>
                                    <option value="IN">Indiana</option>
                                    <option value="IA">Iowa</option>
                                    <option value="KS">Kansas</option>
                                    <option value="KY">Kentucky</option>
                                    <option value="LA">Louisiana</option>
                                    <option value="ME">Maine</option>
                                    <option value="MD">Maryland</option>
                                    <option value="MA">Massachusetts</option>
                                    <option value="MI">Michigan</option>
                                    <option value="MN">Minnesota</option>
                                    <option value="MS">Mississippi</option>
                                    <option value="MO">Missouri</option>
                                    <option value="MT">Montana</option>
                                    <option value="NE">Nebraska</option>
                                    <option value="NV">Nevada</option>
                                    <option value="NH">New Hampshire</option>
                                    <option value="NJ">New Jersey</option>
                                    <option value="NM">New Mexico</option>
                                    <option value="NY">New York</option>
                                    <option value="NC">North Carolina</option>
                                    <option value="ND">North Dakota</option>
                                    <option value="OH">Ohio</option>
                                    <option value="OK">Oklahoma</option>
                                    <option value="OR">Oregon</option>
                                    <option value="PA">Pennsylvania</option>
                                    <option value="RI">Rhode Island</option>
                                    <option value="SC">South Carolina</option>
                                    <option value="SD">South Dakota</option>
                                    <option value="TN">Tennessee</option>
                                    <option value="TX">Texas</option>
                                    <option value="UT">Utah</option>
                                    <option value="VT">Vermont</option>
                                    <option value="VA">Virginia</option>
                                    <option value="WA">Washington</option>
                                    <option value="WV">West Virginia</option>
                                    <option value="WI">Wisconsin</option>
                                    <option value="WY">Wyoming</option>
                                </select>
                            </div>
                            <div>
                                <label class="block text-sm font-medium text-gray-700 mb-2">ZIP Code</label>
                                <input type="text" id="pickupZip"
                                    class="w-full border border-gray-300 rounded-lg px-3 py-2 focus:ring-2 focus:ring-blue-500 focus:border-transparent"
                                    placeholder="43215">
                            </div>
                            <div class="md:col-span-2">
                                <label class="block text-sm font-medium text-gray-700 mb-2">Scheduled Date</label>
                                <input type="datetime-local" id="pickupDate"
                                    class="w-full border border-gray-300 rounded-lg px-3 py-2 focus:ring-2 focus:ring-blue-500 focus:border-transparent">
                            </div>
                        </div>
                    </div>

                    <!-- Delivery Information -->
                    <div class="border-t pt-6">
                        <h4 class="text-lg font-semibold text-gray-900 mb-4">Delivery Information</h4>
                        <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
                            <div>
                                <label class="block text-sm font-medium text-gray-700 mb-2">Delivery Address</label>
                                <input type="text" id="deliveryAddress"
                                    class="w-full border border-gray-300 rounded-lg px-3 py-2 focus:ring-2 focus:ring-blue-500 focus:border-transparent"
                                    placeholder="456 Oak Ave">
                            </div>
                            <div>
                                <label class="block text-sm font-medium text-gray-700 mb-2">City</label>
                                <input type="text" id="deliveryCity"
                                    class="w-full border border-gray-300 rounded-lg px-3 py-2 focus:ring-2 focus:ring-blue-500 focus:border-transparent"
                                    placeholder="Chicago">
                            </div>
                            <div>
                                <label class="block text-sm font-medium text-gray-700 mb-2">State</label>
                                <select id="deliveryState"
                                    class="w-full border border-gray-300 rounded-lg px-3 py-2 focus:ring-2 focus:ring-blue-500 focus:border-transparent">
                                    <option value="">Select State</option>
                                    <option value="AL">Alabama</option>
                                    <option value="AK">Alaska</option>
                                    <option value="AZ">Arizona</option>
                                    <option value="AR">Arkansas</option>
                                    <option value="CA">California</option>
                                    <option value="CO">Colorado</option>
                                    <option value="CT">Connecticut</option>
                                    <option value="DE">Delaware</option>
                                    <option value="FL">Florida</option>
                                    <option value="GA">Georgia</option>
                                    <option value="HI">Hawaii</option>
                                    <option value="ID">Idaho</option>
                                    <option value="IL">Illinois</option>
                                    <option value="IN">Indiana</option>
                                    <option value="IA">Iowa</option>
                                    <option value="KS">Kansas</option>
                                    <option value="KY">Kentucky</option>
                                    <option value="LA">Louisiana</option>
                                    <option value="ME">Maine</option>
                                    <option value="MD">Maryland</option>
                                    <option value="MA">Massachusetts</option>
                                    <option value="MI">Michigan</option>
                                    <option value="MN">Minnesota</option>
                                    <option value="MS">Mississippi</option>
                                    <option value="MO">Missouri</option>
                                    <option value="MT">Montana</option>
                                    <option value="NE">Nebraska</option>
                                    <option value="NV">Nevada</option>
                                    <option value="NH">New Hampshire</option>
                                    <option value="NJ">New Jersey</option>
                                    <option value="NM">New Mexico</option>
                                    <option value="NY">New York</option>
                                    <option value="NC">North Carolina</option>
                                    <option value="ND">North Dakota</option>
                                    <option value="OH">Ohio</option>
                                    <option value="OK">Oklahoma</option>
                                    <option value="OR">Oregon</option>
                                    <option value="PA">Pennsylvania</option>
                                    <option value="RI">Rhode Island</option>
                                    <option value="SC">South Carolina</option>
                                    <option value="SD">South Dakota</option>
                                    <option value="TN">Tennessee</option>
                                    <option value="TX">Texas</option>
                                    <option value="UT">Utah</option>
                                    <option value="VT">Vermont</option>
                                    <option value="VA">Virginia</option>
                                    <option value="WA">Washington</option>
                                    <option value="WV">West Virginia</option>
                                    <option value="WI">Wisconsin</option>
                                    <option value="WY">Wyoming</option>
                                </select>
                            </div>
                            <div>
                                <label class="block text-sm font-medium text-gray-700 mb-2">ZIP Code</label>
                                <input type="text" id="deliveryZip"
                                    class="w-full border border-gray-300 rounded-lg px-3 py-2 focus:ring-2 focus:ring-blue-500 focus:border-transparent"
                                    placeholder="60601">
                            </div>
                            <div class="md:col-span-2">
                                <label class="block text-sm font-medium text-gray-700 mb-2">Scheduled Date</label>
                                <input type="datetime-local" id="deliveryDate"
                                    class="w-full border border-gray-300 rounded-lg px-3 py-2 focus:ring-2 focus:ring-blue-500 focus:border-transparent">
                            </div>
                        </div>
                    </div>

                    <!-- Financial Information -->
                    <div class="border-t pt-6">
                        <h4 class="text-lg font-semibold text-gray-900 mb-4">Financial Information</h4>
                        <div class="grid grid-cols-1 md:grid-cols-3 gap-4">
                            <div>
                                <label class="block text-sm font-medium text-gray-700 mb-2">Total Rate</label>
                                <input type="number" id="totalRate" step="0.01"
                                    class="w-full border border-gray-300 rounded-lg px-3 py-2 focus:ring-2 focus:ring-blue-500 focus:border-transparent"
                                    placeholder="2500.00">
                            </div>
                            <div>
                                <label class="block text-sm font-medium text-gray-700 mb-2">Rate Per Mile</label>
                                <input type="number" id="ratePerMile" step="0.01"
                                    class="w-full border border-gray-300 rounded-lg px-3 py-2 focus:ring-2 focus:ring-blue-500 focus:border-transparent"
                                    placeholder="2.50">
                            </div>
                            <div>
                                <label class="block text-sm font-medium text-gray-700 mb-2">Total Miles</label>
                                <input type="number" id="totalMiles"
                                    class="w-full border border-gray-300 rounded-lg px-3 py-2 focus:ring-2 focus:ring-blue-500 focus:border-transparent"
                                    placeholder="1000">
                            </div>
                        </div>
                        <div class="grid grid-cols-1 md:grid-cols-3 gap-4 mt-4">
                            <div>
                                <label class="block text-sm font-medium text-gray-700 mb-2">Advance Amount</label>
                                <input type="number" id="advanceAmount" step="0.01"
                                    class="w-full border border-gray-300 rounded-lg px-3 py-2 focus:ring-2 focus:ring-blue-500 focus:border-transparent"
                                    placeholder="500.00">
                            </div>
                            <div>
                                <label class="block text-sm font-medium text-gray-700 mb-2">Detention Pay</label>
                                <input type="number" id="detentionPay" step="0.01"
                                    class="w-full border border-gray-300 rounded-lg px-3 py-2 focus:ring-2 focus:ring-blue-500 focus:border-transparent"
                                    placeholder="50.00">
                            </div>
                            <div>
                                <label class="block text-sm font-medium text-gray-700 mb-2">Lumper Fees</label>
                                <input type="number" id="lumperFees" step="0.01"
                                    class="w-full border border-gray-300 rounded-lg px-3 py-2 focus:ring-2 focus:ring-blue-500 focus:border-transparent"
                                    placeholder="75.00">
                            </div>
                        </div>
                    </div>

                    <!-- Driver Assignment -->
                    <div class="border-t pt-6">
                        <h4 class="text-lg font-semibold text-gray-900 mb-4">Driver Assignment</h4>
                        <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
                            <div>
                                <label class="block text-sm font-medium text-gray-700 mb-2">Driver</label>
                                <select id="driver" onchange="autoFillTruckFromDriver(this.value)"
                                    class="w-full border border-gray-300 rounded-lg px-3 py-2 focus:ring-2 focus:ring-blue-500 focus:border-transparent">
                                    <option value="">Unassigned</option>
                                </select>
                            </div>
                            <div>
                                <label class="block text-sm font-medium text-gray-700 mb-2">Truck</label>
                                <select id="truck"
                                    class="w-full border border-gray-300 rounded-lg px-3 py-2 focus:ring-2 focus:ring-blue-500 focus:border-transparent">
                                    <option value="">Select Truck</option>
                                </select>
                            </div>
                        </div>
                    </div>

                    <!-- Document Upload -->
                    <div class="border-t pt-6">
                        <h4 class="text-lg font-semibold text-gray-900 mb-4">Documents</h4>
                        <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
                            <div>
                                <label class="block text-sm font-medium text-gray-700 mb-2">Rate Confirmation</label>
                                <input type="file" id="rateConfirmation" accept=".pdf,.jpg,.jpeg,.png"
                                    class="w-full border border-gray-300 rounded-lg px-3 py-2 focus:ring-2 focus:ring-blue-500 focus:border-transparent">
                            </div>
                            <div>
                                <label class="block text-sm font-medium text-gray-700 mb-2">Bill of Lading</label>
                                <input type="file" id="billOfLading" accept=".pdf,.jpg,.jpeg,.png"
                                    class="w-full border border-gray-300 rounded-lg px-3 py-2 focus:ring-2 focus:ring-blue-500 focus:border-transparent">
                            </div>
                        </div>
                    </div>

                    <!-- Form Actions -->
                    <div class="border-t pt-6 flex justify-end space-x-4">
                        <button type="button" onclick="closeModal()"
                            class="px-6 py-2 border border-gray-300 rounded-lg text-gray-700 hover:bg-gray-50 transition-colors">
                            Cancel
                        </button>
                        <button type="button" onclick="calculateMileage()"
                            class="px-6 py-2 bg-green-600 text-white rounded-lg hover:bg-green-700 transition-colors">
                            Calculate Mileage
                        </button>
                        <button type="submit"
                            class="px-6 py-2 bg-blue-600 text-white rounded-lg hover:bg-blue-700 transition-colors">
                            Save Load
                        </button>
                    </div>
                </form>
            </div>
        </div>
    </div>

    <!-- Footer -->
    <footer class="mt-12 py-8 border-t border-gray-200">
        <div class="text-center">
            <p class="text-gray-600">&copy; 2025 ATS FREIGHT LLC. All rights reserved.</p>
            <p class="text-sm text-gray-500 mt-2">3191 MORSE RD STE 15, COLUMBUS, OH 43231 | (614) 254-0380 | DOT
                3169186</p>
            <p class="text-sm text-gray-500 mt-2">3191 MORSE RD STE 15, COLUMBUS, OH 43231 | (614) 254-0380</p>
        </div>
    </footer>

    <!-- Firebase SDK -->
    <script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-firestore-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-auth-compat.js"></script>

    <script src="data-stability.js"></script>
    <script src="main.js"></script>
    <script src="populate-mock-data.js"></script>
    <script>
        let currentLoadId = null;

        // Initialize page
        document.addEventListener('DOMContentLoaded', async () => {
            Auth.init();
            await DataManager.init();

            // Check for filter from dashboard navigation
            const savedFilter = localStorage.getItem('loadsFilter');
            if (savedFilter) {
                try {
                    const filter = JSON.parse(savedFilter);
                    // Apply date filter if present
                    if (filter.dateFrom && filter.dateTo) {
                        // Show a notification that filter is applied
                        Utils.showNotification('Showing loads from this month', 'info');
                    }
                    // Clear the filter after applying
                    localStorage.removeItem('loadsFilter');
                } catch (e) {
                    console.error('Error parsing loads filter:', e);
                }
            }

            renderLoads();
            populateSelects();

            // Re-render when drivers/customers/trucks change
            window.renderDrivers = populateSelects;
            window.renderCustomers = populateSelects;
            window.renderFleet = populateSelects;
        });

        function populateSelects() {
            const customerSelect = document.getElementById('customer');
            const customerFilter = document.getElementById('customerFilter');
            const driverSelect = document.getElementById('driver');
            const driverFilter = document.getElementById('driverFilter');

            // Customers
            customerSelect.innerHTML = '<option value="">Select Customer</option>';
            customerFilter.innerHTML = '<option value="">All Customers</option>';
            DataManager.customers.forEach(c => {
                const name = c.company?.name || c.name || 'Unknown';
                customerSelect.innerHTML += `<option value="${c.id}">${name}</option>`;
                customerFilter.innerHTML += `<option value="${c.id}">${name}</option>`;
            });

            // Drivers
            driverSelect.innerHTML = '<option value="">Unassigned</option>';
            driverFilter.innerHTML = '<option value="">All Drivers</option>';
            DataManager.drivers.forEach(d => {
                const name = `${d.firstName} ${d.lastName}`;
                driverSelect.innerHTML += `<option value="${d.id}">${name}</option>`;
                driverFilter.innerHTML += `<option value="${d.id}">${name}</option>`;
            });

            // Trucks
            const truckSelect = document.getElementById('truck');
            truckSelect.innerHTML = '<option value="">Select Truck</option>';
            if (DataManager.trucks) {
                DataManager.trucks.forEach(t => {
                    truckSelect.innerHTML += `<option value="${t.id}">${t.number} (${t.make})</option>`;
                });
            }
        }

        function renderLoads() {
            const tbody = document.getElementById('loadsTableBody');
            tbody.innerHTML = '';

            const statusFilter = document.getElementById('statusFilter').value;
            const driverFilter = document.getElementById('driverFilter').value;
            const customerFilter = document.getElementById('customerFilter').value;
            const search = document.getElementById('searchInput').value.toLowerCase();

            // Check for date filter from dashboard (this month's loads)
            const savedFilter = localStorage.getItem('loadsFilter');
            let dateFrom = null;
            let dateTo = null;
            if (savedFilter) {
                try {
                    const filter = JSON.parse(savedFilter);
                    if (filter.dateFrom) dateFrom = new Date(filter.dateFrom);
                    if (filter.dateTo) dateTo = new Date(filter.dateTo);
                } catch (e) {
                    console.error('Error parsing date filter:', e);
                }
            }

            const filtered = DataManager.loads.filter(load => {
                const matchesStatus = !statusFilter || load.status === statusFilter;
                const matchesDriver = !driverFilter || load.driverId === driverFilter;
                const matchesCustomer = !customerFilter || load.customerId === customerFilter;
                const matchesSearch = !search ||
                    (load.loadNumber?.toLowerCase().includes(search)) ||
                    (load.pickup?.city?.toLowerCase().includes(search)) ||
                    (load.delivery?.city?.toLowerCase().includes(search));

                // Apply date filter if present (for "Revenue This Month" navigation)
                let matchesDate = true;
                if (dateFrom && dateTo) {
                    const loadDate = new Date(load.delivery?.date || load.deliveredAt || load.createdAt);
                    matchesDate = loadDate >= dateFrom && loadDate <= dateTo;
                }

                return matchesStatus && matchesDriver && matchesCustomer && matchesSearch && matchesDate;
            });

            filtered.forEach(load => {
                const statusClass = {
                    available: 'status-available',
                    dispatched: 'status-dispatched',
                    'in_transit': 'status-in-transit',
                    delivered: 'status-delivered',
                    cancelled: 'status-cancelled'
                }[load.status] || 'bg-gray-500';

                const statusLabel = load.status.replace(/_/g, ' ').replace(/\b\w/g, c => c.toUpperCase());
                const driverName = load.driver || 'Unassigned';
                const customerName = load.customer || 'Unknown';

                const tr = document.createElement('tr');
                tr.innerHTML = `
                <td class="px-6 py-4 whitespace-nowrap">
                    <div class="text-sm font-medium text-gray-900">${load.loadNumber}</div>
                    <div class="text-sm text-gray-500">Created: ${Utils.formatDate(load.createdAt)}</div>
                </td>
                <td class="px-6 py-4 whitespace-nowrap">
                    <div class="text-sm text-gray-900">${load.pickup?.city || ''}, ${load.pickup?.state || ''}</div>
                    <div class="text-sm text-gray-500">→ ${load.delivery?.city || ''}, ${load.delivery?.state || ''}</div>
                    <div class="text-xs text-gray-400">${load.mileage?.total || 0} miles</div>
                </td>
                <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-900">${customerName}</td>
                <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-900">${driverName}</td>
                <td class="px-6 py-4 whitespace-nowrap">
                    <div class="text-sm font-medium text-gray-900">${Utils.formatCurrency(load.rate?.total || 0)}</div>
                    <div class="text-xs text-gray-500">${Utils.formatCurrency(load.rate?.ratePerMile || 0)}/mile</div>
                </td>
                <td class="px-6 py-4 whitespace-nowrap">
                    <span class="inline-flex px-2 py-1 text-xs font-semibold rounded-full text-white ${statusClass}">
                        ${statusLabel}
                    </span>
                </td>
                <td class="px-6 py-4 whitespace-nowrap text-sm font-medium">
                    <button onclick="editLoad('${load.id}')" class="text-blue-600 hover:text-blue-900 mr-3">
                        <i class="fas fa-edit"></i>
                    </button>
                    <button onclick="viewLoad('${load.id}')" class="text-green-600 hover:text-green-900 mr-3">
                        <i class="fas fa-eye"></i>
                    </button>
                    <button onclick="deleteLoad('${load.id}')" class="text-red-600 hover:text-red-900">
                        <i class="fas fa-trash"></i>
                    </button>
                </td>
            `;
                tbody.appendChild(tr);
            });
        }

        // Helper function for clearing upload
        function clearConfirmationUpload() {
            const uploadInput = document.getElementById('confirmationUpload');
            const fileName = document.getElementById('uploadFileName');
            const clearBtn = document.getElementById('clearUploadBtn');
            if (uploadInput) uploadInput.value = '';
            if (fileName) fileName.textContent = '';
            if (clearBtn) clearBtn.classList.add('hidden');
        }

        // Modal Functions
        function openCreateLoadModal() {
            try {
                currentLoadId = null;
                const modalTitle = document.getElementById('modalTitle');
                const loadForm = document.getElementById('loadForm');
                const loadNumber = document.getElementById('loadNumber');
                const loadModal = document.getElementById('loadModal');

                if (!modalTitle || !loadForm || !loadNumber || !loadModal) {
                    console.error('Required elements not found for load modal');
                    return;
                }

                modalTitle.textContent = 'Create New Load';
                loadForm.reset();
                clearConfirmationUpload();
                loadNumber.value = 'LD-' + (1000 + (DataManager.loads?.length || 0) + 1);
                loadModal.classList.add('show');
            } catch (error) {
                console.error('Error opening load modal:', error);
                Utils.showNotification('Error opening load form. Please refresh the page.', 'error');
            }
        }

        function closeModal() {
            clearConfirmationUpload();
            document.getElementById('loadModal').classList.remove('show');
        }

        // AUTO-FILL TRUCK FROM DRIVER ASSIGNMENT
        function autoFillTruckFromDriver(driverId) {
            const truckSelect = document.getElementById('truck');
            if (!truckSelect || !driverId) return;

            const driver = DataManager.drivers.find(d => d.id === driverId);
            if (driver && driver.currentTruckId) {
                truckSelect.value = driver.currentTruckId;
                console.log(`Auto-filled truck ${driver.currentTruckId} for driver ${driver.firstName} ${driver.lastName}`);
            }
        }

        // Expose functions to global scope for onclick handlers
        window.openCreateLoadModal = openCreateLoadModal;
        window.closeModal = closeModal;
        window.clearConfirmationUpload = clearConfirmationUpload;

        function editLoad(loadId) {
            const load = DataManager.getLoad(loadId);
            if (!load) return;

            currentLoadId = loadId;
            document.getElementById('modalTitle').textContent = `Edit Load - ${load.loadNumber}`;

            document.getElementById('loadNumber').value = load.loadNumber;
            document.getElementById('loadStatus').value = load.status || 'available';
            document.getElementById('customer').value = load.customerId || '';
            document.getElementById('driver').value = load.driverId || '';
            document.getElementById('truck').value = load.truckId || '';

            document.getElementById('pickupAddress').value = load.pickup?.address || '';
            document.getElementById('pickupCity').value = load.pickup?.city || '';
            document.getElementById('pickupState').value = load.pickup?.state || '';
            document.getElementById('pickupZip').value = load.pickup?.zip || '';
            document.getElementById('pickupDate').value = load.pickup?.date || '';

            document.getElementById('deliveryAddress').value = load.delivery?.address || '';
            document.getElementById('deliveryCity').value = load.delivery?.city || '';
            document.getElementById('deliveryState').value = load.delivery?.state || '';
            document.getElementById('deliveryZip').value = load.delivery?.zip || '';
            document.getElementById('deliveryDate').value = load.delivery?.date || '';

            document.getElementById('totalRate').value = load.rate?.total || '';
            document.getElementById('ratePerMile').value = load.rate?.ratePerMile || '';
            document.getElementById('totalMiles').value = load.mileage?.total || '';

            document.getElementById('advanceAmount').value = load.financials?.advanceAmount || '';
            document.getElementById('detentionPay').value = load.financials?.detentionPay || '';
            document.getElementById('lumperFees').value = load.financials?.lumperFees || '';

            document.getElementById('loadModal').classList.add('show');
        }

        async function deleteLoad(loadId) {
            if (confirm('Delete this load permanently?')) {
                await DataManager.deleteLoad(loadId);
                renderLoads();
            }
        }

        // Expose action functions to global scope
        window.editLoad = editLoad;
        window.deleteLoad = deleteLoad;

        function viewLoad(loadId) {
            const load = DataManager.getLoad(loadId);
            if (!load) return;

            alert(`
LOAD #${load.loadNumber}
Status: ${load.status}
Customer: ${load.customer || 'N/A'}
Driver: ${load.driver || 'Unassigned'}
Truck: ${load.truckNumber || 'Unassigned'}

PICKUP: ${load.pickup?.city}, ${load.pickup?.state} @ ${load.pickup?.date || 'N/A'}
DELIVERY: ${load.delivery?.city}, ${load.delivery?.state} @ ${load.delivery?.date || 'N/A'}

Rate: ${Utils.formatCurrency(load.rate?.total || 0)} (${Utils.formatCurrency(load.rate?.ratePerMile || 0)}/mile)
Miles: ${load.mileage?.total || 0}
        `);
        }

        async function calculateMileage() {
            const pickupCity = document.getElementById('pickupCity').value.trim();
            const pickupState = document.getElementById('pickupState').value.trim();
            const deliveryCity = document.getElementById('deliveryCity').value.trim();
            const deliveryState = document.getElementById('deliveryState').value.trim();

            if (!pickupCity || !pickupState || !deliveryCity || !deliveryState) {
                Utils.showNotification('Please enter pickup and delivery cities and states first', 'warning');
                return;
            }

            const origin = `${pickupCity}, ${pickupState}`;
            const destination = `${deliveryCity}, ${deliveryState}`;

            try {
                Utils.showNotification('Calculating mileage...', 'info');

                // Use Utils.calculateDistance which has lookup table and coordinate fallback
                let distance;
                if (typeof Utils !== 'undefined' && Utils.calculateDistance) {
                    distance = Utils.calculateDistance(origin, destination);
                } else if (typeof MapsAPI !== 'undefined' && MapsAPI.calculateRoute) {
                    // Fallback to MapsAPI if Utils not available
                    const result = await MapsAPI.calculateRoute(origin, destination);
                    distance = result?.distance;
                } else {
                    throw new Error('Distance calculation not available');
                }

                if (distance && distance > 0) {
                    document.getElementById('totalMiles').value = distance;

                    // Auto-calculate rate per mile if total rate is already entered
                    const totalRate = parseFloat(document.getElementById('totalRate').value);
                    if (totalRate && totalRate > 0) {
                        const ratePerMile = (totalRate / distance).toFixed(2);
                        document.getElementById('ratePerMile').value = ratePerMile;
                    }

                    Utils.showNotification(`Calculated ${distance} miles`, 'success');
                } else {
                    throw new Error('Invalid distance calculated');
                }
            } catch (err) {
                console.error('Mileage calculation error:', err);
                Utils.showNotification('Failed to calculate mileage. Please enter miles manually.', 'error');
            }
        }

        // Form Submit Handler - Using universal handler pattern
        window.loadForm_handler = async function (e) {
            const btn = e.submitter || document.querySelector('#loadForm button[type="submit"]');
            const original = btn ? btn.textContent : 'Save';
            if (btn) {
                btn.disabled = true;
                btn.textContent = 'Saving...';
            }

            try {
                const loadData = {
                    loadNumber: document.getElementById('loadNumber').value,
                    status: document.getElementById('loadStatus').value,
                    customerId: document.getElementById('customer').value,
                    customer: document.getElementById('customer').selectedOptions[0]?.text || '',
                    driverId: document.getElementById('driver').value || null,
                    driver: document.getElementById('driver').selectedOptions[0]?.text || 'Unassigned',
                    truckId: document.getElementById('truck').value || null,
                    truckNumber: document.getElementById('truck').selectedOptions[0]?.text || 'Unassigned',
                    pickup: {
                        address: document.getElementById('pickupAddress').value,
                        city: document.getElementById('pickupCity').value,
                        state: document.getElementById('pickupState').value,
                        zip: document.getElementById('pickupZip').value,
                        date: document.getElementById('pickupDate').value
                    },
                    delivery: {
                        address: document.getElementById('deliveryAddress').value,
                        city: document.getElementById('deliveryCity').value,
                        state: document.getElementById('deliveryState').value,
                        zip: document.getElementById('deliveryZip').value,
                        date: document.getElementById('deliveryDate').value
                    },
                    rate: {
                        total: parseFloat(document.getElementById('totalRate').value) || 0,
                        ratePerMile: parseFloat(document.getElementById('ratePerMile').value) || 0
                    },
                    mileage: {
                        total: parseFloat(document.getElementById('totalMiles').value) || 0
                    },
                    financials: {
                        advanceAmount: parseFloat(document.getElementById('advanceAmount').value) || 0,
                        detentionPay: parseFloat(document.getElementById('detentionPay').value) || 0,
                        lumperFees: parseFloat(document.getElementById('lumperFees').value) || 0
                    }
                };

                // Calculate company revenue based on driver type
                const grossLoadAmount = loadData.rate.total;
                loadData.grossLoadAmount = grossLoadAmount; // Store gross amount
                // Get driver object for calculation
                const driver = loadData.driverId ? DataManager.drivers.find(d => d.id === loadData.driverId) : null;
                loadData.companyRevenue = Utils.calculateCompanyRevenueSync(grossLoadAmount, driver);

                if (currentLoadId) {
                    // Get the original load to check for status change
                    const originalLoad = DataManager.getLoad(currentLoadId);
                    const oldStatus = originalLoad ? originalLoad.status : '';
                    const newStatus = loadData.status;

                    await DataManager.updateLoad(currentLoadId, loadData);
                    Utils.logActivity('Load Updated', `Load #${loadData.loadNumber} updated`, 'load');

                    // If status changed to 'delivered', trigger settlement update and invoice creation
                    if (oldStatus !== 'delivered' && newStatus === 'delivered') {
                        const load = DataManager.getLoad(currentLoadId); // Get updated load data
                        if (!load) return;

                        // Automatically create invoice for delivered load
                        if (window.createInvoiceForLoad) {
                            try {
                                await window.createInvoiceForLoad(currentLoadId);
                                Utils.logActivity('Invoice Created', `Auto-invoice for Load #${load.loadNumber}`, 'money');
                            } catch (err) {
                                console.error('Error creating invoice for load:', err);
                            }
                        }

                        Utils.logActivity('Load Delivered', `Load #${load.loadNumber} marked as delivered`, 'load');

                        const driver = DataManager.drivers.find(d => d.id === load.driverId);
                        if (!driver) {
                            console.warn('No driver found for load', currentLoadId);
                        } else {
                            let driverPay = 0;
                            if (driver.payment?.type === 'percentage') {
                                // Use ONLY driver.payPercentage (stored as decimal 0-1)
                                const driverPayPercentage = Utils.validatePayPercentage(driver.payPercentage, driver.driverType);
                                driverPay = parseFloat(load.rate?.total || 0) * driverPayPercentage;
                            } else {
                                // Per mile (default)
                                const miles = parseFloat(load.mileage?.total || 0);
                                const rate = parseFloat(driver.payment?.perMileRate || 0);
                                driverPay = miles * rate;
                            }

                            // Find or create this week's settlement
                            const weekStart = Utils.getWeekStart(new Date());
                            const weekKey = weekStart.toISOString().split('T')[0];

                            let settlement = DataManager.settlements.find(s =>
                                s.driverId === load.driverId &&
                                s.weekStart === weekKey
                            );

                            if (!settlement) {
                                settlement = {
                                    settlementNumber: `ST-${new Date().getFullYear()}-${DataManager.settlements.length + 1000}`,
                                    driverId: load.driverId,
                                    driverName: `${driver.firstName} ${driver.lastName}`,
                                    period: `Week ${Utils.getWeekNumber(new Date())}`,
                                    weekStart: weekKey,
                                    grossPay: 0,
                                    totalDeductions: 0,
                                    netPay: 0,
                                    loadIds: [],
                                    totalMiles: 0,
                                    status: 'pending',
                                    createdAt: new Date().toISOString()
                                };
                                const id = await DataManager.addSettlement(settlement);
                                settlement.id = id;
                            }

                            // Add this load's pay
                            // Ensure we don't double count if load is already in settlement
                            if (!settlement.loadIds.includes(currentLoadId)) {
                                settlement.grossPay = (parseFloat(settlement.grossPay) || 0) + driverPay;
                                settlement.totalMiles = (parseFloat(settlement.totalMiles) || 0) + (parseFloat(load.mileage?.total) || 0);
                                settlement.loadIds.push(currentLoadId);
                                settlement.netPay = settlement.grossPay - (parseFloat(settlement.totalDeductions) || 0);

                                await DataManager.updateSettlement(settlement.id, {
                                    grossPay: settlement.grossPay,
                                    totalMiles: settlement.totalMiles,
                                    loadIds: settlement.loadIds,
                                    netPay: settlement.netPay
                                });

                                // Link load to settlement
                                await DataManager.updateLoad(currentLoadId, { settlementId: settlement.id });

                                Utils.showNotification(`$${driverPay.toFixed(2)} added to ${driver.firstName}'s settlement`, 'success');
                            }
                        }
                    }
                } else {
                    await DataManager.addLoad(loadData);
                    Utils.logActivity('Load Created', `New Load #${loadData.loadNumber} created`, 'load');
                }

                closeModal();
                renderLoads();
                Utils.showNotification('Load saved successfully!', 'success');
            } catch (err) {
                Utils.showNotification('Error saving load: ' + (err.message || 'Unknown error'), 'error');
                console.error(err);
                throw err; // Re-throw so universal handler can catch it
            } finally {
                if (btn) {
                    btn.disabled = false;
                    btn.textContent = original;
                }
            }
        };

        // Rate Confirmation Upload Handler
        async function handleConfirmationUpload(event) {
            const file = event.target.files[0];
            if (!file) return;

            const fileName = file.name;
            document.getElementById('uploadFileName').textContent = fileName;
            document.getElementById('uploadProgress').classList.remove('hidden');
            document.getElementById('clearUploadBtn').classList.remove('hidden');

            try {
                // Process the document with OCR using Utils
                let text = '';
                if (file.type === 'application/pdf') {
                    text = await Utils.processPDFRateConfirmation(file);
                } else {
                    // Fallback for images if needed, or just use the same function if it handles both
                    // For now, we'll assume the PDF function is the primary one as requested
                    text = await Utils.processPDFRateConfirmation(file);
                }

                console.log('Extracted Text:', text);

                if (text) {
                    const fields = parseRateConfirmationText(text);
                    console.log('Parsed Fields:', fields);

                    // Populate form fields with extracted data
                    if (fields.loadNumber) {
                        document.getElementById('loadNumber').value = fields.loadNumber;
                    }

                    if (fields.rate) {
                        document.getElementById('totalRate').value = fields.rate;
                    }

                    // Calculate rate per mile if miles are available
                    if (fields.miles) {
                        document.getElementById('totalMiles').value = fields.miles;
                        if (fields.rate) {
                            const rpm = (parseFloat(fields.rate) / parseFloat(fields.miles)).toFixed(2);
                            document.getElementById('ratePerMile').value = rpm;
                        }
                    }

                    if (fields.pickupCity) document.getElementById('pickupCity').value = fields.pickupCity;
                    if (fields.pickupState) document.getElementById('pickupState').value = fields.pickupState;
                    if (fields.pickupZip) document.getElementById('pickupZip').value = fields.pickupZip;

                    if (fields.deliveryCity) document.getElementById('deliveryCity').value = fields.deliveryCity;
                    if (fields.deliveryState) document.getElementById('deliveryState').value = fields.deliveryState;
                    if (fields.deliveryZip) document.getElementById('deliveryZip').value = fields.deliveryZip;

                    // Handle dates
                    if (fields.pickupDate) {
                        // Try to format for datetime-local input (YYYY-MM-DDTHH:mm)
                        try {
                            const date = new Date(fields.pickupDate);
                            if (!isNaN(date.getTime())) {
                                const isoString = date.toISOString().slice(0, 16);
                                document.getElementById('pickupDate').value = isoString;
                            }
                        } catch (e) { console.warn('Error parsing pickup date', e); }
                    }

                    if (fields.deliveryDate) {
                        try {
                            const date = new Date(fields.deliveryDate);
                            if (!isNaN(date.getTime())) {
                                const isoString = date.toISOString().slice(0, 16);
                                document.getElementById('deliveryDate').value = isoString;
                            }
                        } catch (e) { console.warn('Error parsing delivery date', e); }
                    }

                    // Show success notification
                    Utils.showNotification(`Successfully extracted data from ${fileName}! Please review and complete any missing fields.`, 'success');

                    // Scroll to top of form to show populated fields
                    document.querySelector('#loadModal .modal-content').scrollTop = 0;
                } else {
                    Utils.showNotification('Could not extract text from document. Please enter information manually.', 'warning');
                }
            } catch (error) {
                console.error('Error processing confirmation:', error);
                Utils.showNotification('Error processing document: ' + error.message, 'error');
            } finally {
                document.getElementById('uploadProgress').classList.add('hidden');
            }
        }

        // Helper function to parse extracted text
        function parseRateConfirmationText(text) {
            const fields = {};

            // Normalize text for easier matching
            const lines = text.split('\n');

            // 1. Load Number
            // Look for patterns like "Load #", "Load Number", "Order #", "Reference #"
            const loadNumMatch = text.match(/(?:Load|Order|Reference|Ref|Shipment)\s*(?:#|Number|No\.?|ID)?\s*[:.]?\s*([A-Z0-9-]{4,})/i);
            if (loadNumMatch) {
                fields.loadNumber = loadNumMatch[1].trim();
            }

            // 2. Rate / Amount
            // Look for currency patterns, often associated with "Rate", "Total", "Amount", "Flat"
            // We look for the largest currency amount usually
            const moneyMatches = text.matchAll(/\$\s*([0-9,]+\.[0-9]{2})/g);
            let maxAmount = 0;
            for (const match of moneyMatches) {
                const amount = parseFloat(match[1].replace(/,/g, ''));
                if (amount > maxAmount && amount < 100000) { // Sanity check < 100k
                    maxAmount = amount;
                }
            }
            if (maxAmount > 0) {
                fields.rate = maxAmount;
            }

            // 3. Locations (City, State Zip)
            // This is harder, we look for "City, ST Zip" patterns
            // We assume the first one found is pickup, second is delivery, or look for keywords

            // Regex for City, ST Zip (simplified)
            const locationRegex = /([A-Za-z\s]+),\s*([A-Z]{2})\s*(\d{5})?/;

            // Try to find sections based on keywords
            const pickupKeywords = ['pickup', 'origin', 'shipper', 'load at'];
            const deliveryKeywords = ['delivery', 'destination', 'consignee', 'deliver to', 'unload at'];

            let pickupFound = false;
            let deliveryFound = false;

            for (let i = 0; i < lines.length; i++) {
                const line = lines[i].trim();
                const lowerLine = line.toLowerCase();

                // Check if this line or nearby lines contain location info
                const locMatch = line.match(locationRegex);

                if (locMatch) {
                    // Determine if it's pickup or delivery based on context (previous lines)
                    let context = '';
                    if (i > 0) context += lines[i - 1].toLowerCase();
                    if (i > 1) context += lines[i - 2].toLowerCase();

                    const isPickup = pickupKeywords.some(kw => context.includes(kw) || lowerLine.includes(kw));
                    const isDelivery = deliveryKeywords.some(kw => context.includes(kw) || lowerLine.includes(kw));

                    if (isPickup && !pickupFound) {
                        fields.pickupCity = locMatch[1].trim();
                        fields.pickupState = locMatch[2].trim();
                        if (locMatch[3]) fields.pickupZip = locMatch[3].trim();
                        pickupFound = true;
                    } else if (isDelivery && !deliveryFound) {
                        fields.deliveryCity = locMatch[1].trim();
                        fields.deliveryState = locMatch[2].trim();
                        if (locMatch[3]) fields.deliveryZip = locMatch[3].trim();
                        deliveryFound = true;
                    }
                }
            }

            // 4. Dates
            // Look for date patterns MM/DD/YYYY or similar
            const dateRegex = /(\d{1,2})[\/\-\.](\d{1,2})[\/\-\.](\d{2,4})/;
            // This is very heuristic, would need more robust logic for real world
            // For now, we'll try to find dates near the locations

            return fields;
        }


        // Filters
        ['statusFilter', 'driverFilter', 'customerFilter', 'searchInput'].forEach(id => {
            document.getElementById(id)?.addEventListener('change input'.split(' ')[id === 'searchInput' ? 1 : 0], renderLoads);
        });

        // Close modal on background click
        window.onclick = (e) => {
            if (e.target.id === 'loadModal') closeModal();
        };
    </script>
</body>

</html>