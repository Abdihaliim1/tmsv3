<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Dashboard - ATS FREIGHT LLC</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/js/all.min.js"></script>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700;800;900&display=swap"
        rel="stylesheet">
    <!-- Mobile Responsiveness -->
    <link rel="stylesheet" href="mobile-fixes.css">
    <script src="mobile-nav.js" defer></script>
    <style>
        body {
            font-family: 'Inter', sans-serif;
        }

        .sidebar {
            width: 250px;
            background: linear-gradient(180deg, #1f2937 0%, #111827 100%);
        }

        .main-content {
            margin-left: 250px;
        }

        .company-logo {
            width: 60px;
            height: 60px;
            background: linear-gradient(135deg, #3b82f6 0%, #1d4ed8 100%);
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 24px;
            font-weight: bold;
            color: #ffffff;
            box-shadow: 0 4px 6px -1px rgba(0, 0, 0, 0.1);
        }

        .sidebar-item {
            transition: all 0.2s ease;
        }

        .sidebar-item:hover {
            background-color: rgba(255, 255, 255, 0.1);
            transform: translateX(4px);
        }

        .sidebar-item.active {
            background-color: rgba(255, 255, 255, 0.15);
            border-left: 4px solid #3b82f6;
        }

        .metric-card {
            transition: all 0.3s ease;
            background: linear-gradient(135deg, #ffffff 0%, #f8fafc 100%);
            border: 1px solid #e2e8f0;
        }

        .metric-card:hover {
            transform: translateY(-4px);
            box-shadow: 0 20px 25px -5px rgba(0, 0, 0, 0.1), 0 10px 10px -5px rgba(0, 0, 0, 0.04);
        }

        .kpi-icon {
            width: 48px;
            height: 48px;
            border-radius: 12px;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 20px;
        }

        .kpi-revenue {
            background: linear-gradient(135deg, #10b981 0%, #059669 100%);
        }

        .kpi-loads {
            background: linear-gradient(135deg, #3b82f6 0%, #1d4ed8 100%);
        }

        .kpi-drivers {
            background: linear-gradient(135deg, #8b5cf6 0%, #7c3aed 100%);
        }

        .kpi-profit {
            background: linear-gradient(135deg, #f59e0b 0%, #d97706 100%);
        }

        .quick-action {
            transition: all 0.2s ease;
        }

        .quick-action:hover {
            transform: translateY(-2px);
            box-shadow: 0 10px 15px -3px rgba(0, 0, 0, 0.1);
        }

        @media (max-width: 1024px) {
            .sidebar {
                transform: translateX(-100%);
                position: fixed;
                z-index: 50;
                height: 100vh;
            }

            .sidebar.open {
                transform: translateX(0);
            }

            .main-content {
                margin-left: 0;
            }
        }
    </style>
</head>

<body class="bg-gray-50">
    <!-- Mobile Menu Button -->
    <button id="mobileMenuBtn" class="lg:hidden fixed top-4 left-4 z-50 bg-gray-800 text-white p-2 rounded-lg">
        <i class="fas fa-bars"></i>
    </button>

    <!-- Sidebar -->
    <div id="sidebar" class="sidebar fixed left-0 top-0 h-full text-white z-40">
        <div class="p-6">
            <div class="flex items-center space-x-3 mb-8">
                <img src="resources/ats-freight-logo.png" alt="ATS FREIGHT LLC"
                    class="w-16 h-16 object-contain rounded-lg"
                    onerror="this.classList.add('hidden'); this.nextElementSibling.classList.remove('hidden'); this.nextElementSibling.classList.add('flex');">
                <div class="company-logo hidden">ATS</div>
                <div>
                    <h2 class="text-xl font-bold">ATS FREIGHT LLC</h2>
                    <p class="text-sm opacity-75">TMS</p>
                </div>
            </div>

            <nav class="space-y-2">
                <a href="index.html"
                    class="sidebar-item active flex items-center px-4 py-3 rounded-lg text-sm font-medium">
                    <i class="fas fa-tachometer-alt mr-3 w-5"></i>
                    Dashboard
                </a>
                <a href="loads.html" class="sidebar-item flex items-center px-4 py-3 rounded-lg text-sm font-medium">
                    <i class="fas fa-truck mr-3 w-5"></i>
                    Loads
                </a>
                <a href="drivers.html" class="sidebar-item flex items-center px-4 py-3 rounded-lg text-sm font-medium">
                    <i class="fas fa-users mr-3 w-5"></i>
                    Drivers
                </a>
                <a href="fleet.html" class="sidebar-item flex items-center px-4 py-3 rounded-lg text-sm font-medium">
                    <i class="fas fa-truck-monster mr-3 w-5"></i>
                    Fleet
                </a>
                <a href="customers.html"
                    class="sidebar-item flex items-center px-4 py-3 rounded-lg text-sm font-medium">
                    <i class="fas fa-building mr-3 w-5"></i>
                    Customers
                </a>
                <a href="expenses.html" class="sidebar-item flex items-center px-4 py-3 rounded-lg text-sm font-medium">
                    <i class="fas fa-receipt mr-3 w-5"></i>
                    Expenses
                </a>
                <a href="invoices.html" class="sidebar-item flex items-center px-4 py-3 rounded-lg text-sm font-medium">
                    <i class="fas fa-file-invoice mr-3 w-5"></i>
                    Invoices
                </a>
                <a href="settlements.html"
                    class="sidebar-item flex items-center px-4 py-3 rounded-lg text-sm font-medium">
                    <i class="fas fa-calculator mr-3 w-5"></i>
                    Settlements
                </a>
                <a href="reports.html" class="sidebar-item flex items-center px-4 py-3 rounded-lg text-sm font-medium">
                    <i class="fas fa-chart-bar mr-3 w-5"></i>
                    Reports
                </a>
                <a href="import.html" class="sidebar-item flex items-center px-4 py-3 rounded-lg text-sm font-medium">
                    <i class="fas fa-upload mr-3 w-5"></i>
                    Import
                </a>
            </nav>
        </div>

        <div class="absolute bottom-6 left-6 right-6">
            <button onclick="CompanySettings.openModal()"
                class="w-full flex items-center px-4 py-3 rounded-lg text-sm font-medium bg-white bg-opacity-10 hover:bg-opacity-20 transition-all">
                <i class="fas fa-cog mr-3 w-5"></i>
                Company Settings
            </button>
        </div>
    </div>

    <!-- Main Content -->
    <div class="main-content">
        <!-- Header -->
        <header class="bg-white border-b border-gray-200 shadow-sm">
            <div class="px-6 py-4">
                <div class="flex justify-between items-center">
                    <div>
                        <h1 class="text-3xl font-bold text-gray-900">Dashboard Overview</h1>
                        <p class="text-gray-600 mt-1">Real-time insights for your trucking operations</p>
                    </div>
                    <div class="bg-green-100 text-green-800 px-4 py-2 rounded-full font-medium text-sm">
                        <i class="fas fa-circle text-green-500 mr-2"></i>
                        System Online
                    </div>
                </div>
            </div>
        </header>

        <!-- Main Content -->
        <main class="px-6 py-8">
            <!-- KPI Cards -->
            <div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-4 gap-6 mb-8">
                <div class="metric-card rounded-xl p-6">
                    <div class="flex items-center justify-between mb-4">
                        <div class="kpi-icon kpi-loads text-white">
                            <i class="fas fa-truck"></i>
                        </div>
                        <div class="text-right">
                            <p class="text-sm font-medium text-gray-500">Active Loads</p>
                            <p id="activeLoads" class="text-2xl font-bold text-gray-900">0</p>
                        </div>
                    </div>
                    <div class="flex items-center text-sm">
                        <span class="text-blue-600 flex items-center">
                            <i class="fas fa-arrow-up mr-1"></i>
                            +12%
                        </span>
                        <span class="text-gray-500 ml-2">from last week</span>
                    </div>
                </div>

                <div class="metric-card rounded-xl p-6">
                    <div class="flex items-center justify-between mb-4">
                        <div class="kpi-icon kpi-revenue text-white">
                            <i class="fas fa-dollar-sign"></i>
                        </div>
                        <div class="text-right">
                            <p class="text-sm font-medium text-gray-500">Revenue This Month</p>
                            <p id="revenueThisMonth" class="text-2xl font-bold text-gray-900">$0</p>
                        </div>
                    </div>
                    <div class="flex items-center text-sm">
                        <span class="text-emerald-600 flex items-center">
                            <i class="fas fa-arrow-up mr-1"></i>
                            +8%
                        </span>
                        <span class="text-gray-500 ml-2">from last month</span>
                    </div>
                </div>

                <div class="metric-card rounded-xl p-6">
                    <div class="flex items-center justify-between mb-4">
                        <div class="kpi-icon kpi-drivers text-white">
                            <i class="fas fa-users"></i>
                        </div>
                        <div class="text-right">
                            <p class="text-sm font-medium text-gray-500">Active Drivers</p>
                            <p id="activeDrivers" class="text-2xl font-bold text-gray-900">0</p>
                        </div>
                    </div>
                    <div class="flex items-center text-sm">
                        <span class="text-purple-600 flex items-center">
                            <i class="fas fa-check mr-1"></i>
                            All active
                        </span>
                    </div>
                </div>

                <div class="metric-card rounded-xl p-6" id="profitCard">
                    <div class="flex items-center justify-between mb-4">
                        <div class="kpi-icon kpi-profit text-white">
                            <i class="fas fa-chart-line"></i>
                        </div>
                        <div class="text-right">
                            <p class="text-sm font-medium text-gray-500">Profit This Month</p>
                            <p id="profitThisMonth" class="text-2xl font-bold text-gray-900">$0</p>
                        </div>
                    </div>
                    <div class="flex items-center text-sm">
                        <span id="profitTrend" class="text-emerald-600 flex items-center">
                            <i class="fas fa-arrow-up mr-1"></i>
                            Profitable
                        </span>
                    </div>
                </div>
            </div>

            <!-- Quick Actions -->
            <div class="mb-8">
                <h2 class="text-xl font-semibold mb-4 text-gray-900">Quick Actions</h2>
                <div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-4 xl:grid-cols-8 gap-4">
                    <a href="loads.html"
                        class="quick-action bg-white p-6 rounded-xl shadow-sm border border-gray-200 flex items-center">
                        <div class="w-12 h-12 bg-blue-100 rounded-lg flex items-center justify-center mr-4">
                            <i class="fas fa-plus text-blue-600"></i>
                        </div>
                        <div>
                            <h3 class="font-medium text-gray-900">Add New Load</h3>
                            <p class="text-sm text-gray-500">Create a new load</p>
                        </div>
                    </a>

                    <a href="drivers.html"
                        class="quick-action bg-white p-6 rounded-xl shadow-sm border border-gray-200 flex items-center">
                        <div class="w-12 h-12 bg-green-100 rounded-lg flex items-center justify-center mr-4">
                            <i class="fas fa-users text-green-600"></i>
                        </div>
                        <div>
                            <h3 class="font-medium text-gray-900">Manage Drivers</h3>
                            <p class="text-sm text-gray-500">View driver details</p>
                        </div>
                    </a>

                    <a href="dispatch.html"
                        class="quick-action bg-white p-6 rounded-xl shadow-sm border border-gray-200 flex items-center">
                        <div class="w-12 h-12 bg-indigo-100 rounded-lg flex items-center justify-center mr-4">
                            <i class="fas fa-calendar-alt text-indigo-600"></i>
                        </div>
                        <div>
                            <h3 class="font-medium text-gray-900">Dispatch Board</h3>
                            <p class="text-sm text-gray-500">Visual load planning</p>
                        </div>
                    </a>

                    <a href="accounts-receivable.html"
                        class="quick-action bg-white p-6 rounded-xl shadow-sm border border-gray-200 flex items-center">
                        <div class="w-12 h-12 bg-purple-100 rounded-lg flex items-center justify-center mr-4">
                            <i class="fas fa-chart-line text-purple-600"></i>
                        </div>
                        <div>
                            <h3 class="font-medium text-gray-900">AR & Aging</h3>
                            <p class="text-sm text-gray-500">Track receivables</p>
                        </div>
                    </a>

                    <a href="settlements.html"
                        class="quick-action bg-white p-6 rounded-xl shadow-sm border border-gray-200 flex items-center">
                        <div class="w-12 h-12 bg-purple-100 rounded-lg flex items-center justify-center mr-4">
                            <i class="fas fa-calculator text-purple-600"></i>
                        </div>
                        <div>
                            <h3 class="font-medium text-gray-900">Generate Settlement</h3>
                            <p class="text-sm text-gray-500">Create driver settlement</p>
                        </div>
                    </a>

                    <a href="reports.html"
                        class="quick-action bg-white p-6 rounded-xl shadow-sm border border-gray-200 flex items-center">
                        <div class="w-12 h-12 bg-orange-100 rounded-lg flex items-center justify-center mr-4">
                            <i class="fas fa-chart-bar text-orange-600"></i>
                        </div>
                        <div>
                            <h3 class="font-medium text-gray-900">View Reports</h3>
                            <p class="text-sm text-gray-500">Business analytics</p>
                        </div>
                    </a>

                    <button onclick="cleanupMockData()"
                        class="quick-action bg-white p-6 rounded-xl shadow-sm border border-gray-200 flex items-center hover:bg-red-50 transition-colors">
                        <div class="w-12 h-12 bg-red-100 rounded-lg flex items-center justify-center mr-4">
                            <i class="fas fa-trash-alt text-red-600"></i>
                        </div>
                        <div>
                            <h3 class="font-medium text-red-900">Clean All Data</h3>
                            <p class="text-sm text-red-500">Delete everything</p>
                        </div>
                    </button>
                </div>
            </div>

            <!-- Recent Activity -->
            <div class="bg-white rounded-xl shadow-sm border border-gray-200 p-6">
                <h2 class="text-xl font-semibold mb-4 text-gray-900">Recent Activity</h2>
                <div id="recentActivity" class="space-y-4">
                    <div class="flex items-center p-3 bg-gray-50 rounded-lg">
                        <div class="w-8 h-8 bg-blue-100 rounded-full flex items-center justify-center mr-3">
                            <i class="fas fa-truck text-blue-600 text-sm"></i>
                        </div>
                        <div class="flex-1">
                            <p class="text-sm font-medium text-gray-900">System initialized successfully</p>
                            <p class="text-xs text-gray-500">Dashboard is ready for use</p>
                        </div>
                        <span class="text-xs text-gray-400">Just now</span>
                    </div>
                </div>
            </div>
        </main>
    </div>

    <!-- Firebase SDK -->
    <script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-firestore-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-auth-compat.js"></script>

    <script src="data-stability.js"></script>
    <script src="main.js"></script>
    <script src="populate-mock-data.js"></script>
    <script src="cleanup-mock-data.js"></script>
    <script src="final-test.js"></script>

    <script>
        // Mobile menu toggle
        document.getElementById('mobileMenuBtn').addEventListener('click', function () {
            const sidebar = document.getElementById('sidebar');
            sidebar.classList.toggle('open');
        });

        // Dashboard Manager - Real Data Integration
        const DashboardManager = {
            currentStats: {
                activeLoads: 0,
                revenueThisMonth: 0,
                activeDrivers: 0,
                profitThisMonth: 0
            },

            init: function () {
                this.calculateStats();
                this.updateUI();
                this.subscribeToActivityLog();

                // Refresh every 30 seconds
                setInterval(() => {
                    this.calculateStats();
                    this.updateUI();
                }, 30000);
            },

            subscribeToActivityLog: function () {
                const recentActivityContainer = document.getElementById('recentActivity');
                if (!recentActivityContainer) return;

                db.collection('activityLog')
                    .orderBy('timestamp', 'desc')
                    .limit(15)
                    .onSnapshot((snapshot) => {
                        if (snapshot.empty) {
                            recentActivityContainer.innerHTML = `
                                <div class="text-center py-8 text-gray-500">
                                    <p>No recent activity</p>
                                </div>
                            `;
                            return;
                        }

                        let html = '';
                        snapshot.forEach(doc => {
                            const activity = doc.data();
                            const timeAgo = this.getTimeAgo(activity.timestamp ? activity.timestamp.toDate() : new Date());

                            // Icon mapping
                            let iconClass = 'fa-info-circle';
                            let bgClass = 'bg-gray-100';
                            let textClass = 'text-gray-600';

                            switch (activity.type) {
                                case 'load':
                                    iconClass = 'fa-truck';
                                    bgClass = 'bg-blue-100';
                                    textClass = 'text-blue-600';
                                    break;
                                case 'driver':
                                    iconClass = 'fa-user';
                                    bgClass = 'bg-purple-100';
                                    textClass = 'text-purple-600';
                                    break;
                                case 'money':
                                    iconClass = 'fa-dollar-sign';
                                    bgClass = 'bg-green-100';
                                    textClass = 'text-green-600';
                                    break;
                                case 'alert':
                                    iconClass = 'fa-exclamation-circle';
                                    bgClass = 'bg-red-100';
                                    textClass = 'text-red-600';
                                    break;
                                case 'system':
                                    iconClass = 'fa-cog';
                                    bgClass = 'bg-gray-100';
                                    textClass = 'text-gray-600';
                                    break;
                            }

                            html += `
                                <div class="flex items-center p-3 bg-gray-50 rounded-lg hover:bg-gray-100 transition-colors">
                                    <div class="w-8 h-8 ${bgClass} rounded-full flex items-center justify-center mr-3 flex-shrink-0">
                                        <i class="fas ${iconClass} ${textClass} text-sm"></i>
                                    </div>
                                    <div class="flex-1 min-w-0">
                                        <p class="text-sm font-medium text-gray-900 truncate">${activity.action}</p>
                                        <p class="text-xs text-gray-500 truncate">${activity.details}</p>
                                    </div>
                                    <div class="text-right ml-2 flex-shrink-0">
                                        <span class="text-xs text-gray-400 block">${timeAgo}</span>
                                        <span class="text-xs text-gray-300 block">${activity.user?.name?.split(' ')[0] || 'System'}</span>
                                    </div>
                                </div>
                            `;
                        });

                        recentActivityContainer.innerHTML = html;
                    }, (error) => {
                        console.error("Error getting activity log:", error);
                        recentActivityContainer.innerHTML = `
                            <div class="text-center py-4 text-red-500 text-sm">
                                <p>Error loading activity feed</p>
                            </div>
                        `;
                    });
            },

            getTimeAgo: function (date) {
                const seconds = Math.floor((new Date() - date) / 1000);

                let interval = seconds / 31536000;
                if (interval > 1) return Math.floor(interval) + "y ago";

                interval = seconds / 2592000;
                if (interval > 1) return Math.floor(interval) + "mo ago";

                interval = seconds / 86400;
                if (interval > 1) return Math.floor(interval) + "d ago";

                interval = seconds / 3600;
                if (interval > 1) return Math.floor(interval) + "h ago";

                interval = seconds / 60;
                if (interval > 1) return Math.floor(interval) + "m ago";

                return "Just now";
            },

            calculateStats: function () {
                if (!window.DataManager) return;

                const loads = DataManager.loads || [];
                const drivers = DataManager.drivers || [];
                const expenses = DataManager.expenses || [];
                const settlements = DataManager.settlements || [];

                // Calculate active loads (not delivered/cancelled)
                this.currentStats.activeLoads = loads.filter(l => {
                    const status = (l.status || '').toLowerCase();
                    return !['delivered', 'completed', 'cancelled'].includes(status);
                }).length;

                // Calculate active drivers
                this.currentStats.activeDrivers = drivers.filter(d => d.status === 'active').length;

                // Calculate this month's revenue and profit
                const now = new Date();
                const startOfMonth = new Date(now.getFullYear(), now.getMonth(), 1);

                const thisMonthLoads = loads.filter(l => {
                    const date = new Date(l.deliveredAt || l.createdAt);
                    return date >= startOfMonth && (l.status === 'delivered' || l.status === 'completed');
                });

                this.currentStats.revenueThisMonth = thisMonthLoads.reduce((sum, l) => {
                    return sum + (parseFloat(l.rate?.total || l.rate || 0) || 0);
                }, 0);

                // Calculate profit (simplified)
                const thisMonthExpenses = expenses.filter(e => {
                    const date = new Date(e.date || e.createdAt);
                    return date >= startOfMonth;
                }).reduce((sum, e) => sum + (parseFloat(e.amount) || 0), 0);

                const thisMonthDriverPay = settlements.filter(s => {
                    const date = new Date(s.createdAt);
                    return date >= startOfMonth;
                }).reduce((sum, s) => sum + (parseFloat(s.netPay) || 0), 0);

                this.currentStats.profitThisMonth = this.currentStats.revenueThisMonth - thisMonthExpenses - thisMonthDriverPay;
            },

            updateUI: function () {
                // Update KPI cards
                document.getElementById('activeLoads').textContent = this.currentStats.activeLoads.toLocaleString();
                document.getElementById('revenueThisMonth').textContent = Utils.formatCurrency(this.currentStats.revenueThisMonth);
                document.getElementById('activeDrivers').textContent = this.currentStats.activeDrivers.toLocaleString();
                document.getElementById('profitThisMonth').textContent = Utils.formatCurrency(this.currentStats.profitThisMonth);

                // Update profit card styling
                const profitCard = document.getElementById('profitCard');
                const profitTrend = document.getElementById('profitTrend');

                if (this.currentStats.profitThisMonth >= 0) {
                    profitTrend.innerHTML = '<i class="fas fa-arrow-up mr-1"></i>Profitable';
                    profitTrend.className = 'text-emerald-600 flex items-center';
                } else {
                    profitTrend.innerHTML = '<i class="fas fa-arrow-down mr-1"></i>Loss';
                    profitTrend.className = 'text-rose-600 flex items-center';
                }
            },

            refresh: function () {
                this.calculateStats();
                this.updateUI();
            }
        };

        // Initialize when DOM is loaded
        document.addEventListener('DOMContentLoaded', async function () {
            // Wait for DataManager to be ready
            if (window.DataManager) {
                await DataManager.init();
                // Small delay to ensure all data is loaded
                await new Promise(resolve => setTimeout(resolve, 1000));
            }

            // Initialize dashboard
            DashboardManager.init();

            // Make it globally available
            window.DashboardManager = DashboardManager;
        });

        // Global refresh function for other pages to call
        window.updateDashboard = function () {
            if (window.DashboardManager) {
                DashboardManager.refresh();
            }
        };
    </script>
</body>

</html>