<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Driver Management - ATS FREIGHT LLC</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/js/all.min.js"></script>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700;800;900&display=swap"
        rel="stylesheet">
    <!-- Mobile Responsiveness -->
    <link rel="stylesheet" href="mobile-fixes.css">
    <script src="mobile-nav.js" defer></script>
    <style>
        body {
            font-family: 'Inter', sans-serif;
        }

        .bg-navy {
            background-color: #1f2937;
        }

        .text-navy {
            color: #1f2937;
        }

        .gradient-bg {
            background-color: #1f2937;
        }

        .card-shadow {
            box-shadow: 0 4px 6px -1px rgba(0, 0, 0, 0.1), 0 2px 4px -1px rgba(0, 0, 0, 0.06);
        }

        .status-active {
            background-color: #10b981;
        }

        .status-inactive {
            background-color: #6b7280;
        }

        .status-terminated {
            background-color: #ef4444;
        }

        .nav-item {
            transition: all 0.2s ease;
        }

        .nav-item:hover {
            background-color: rgba(255, 255, 255, 0.1);
        }

        .nav-item.active {
            background-color: rgba(255, 255, 255, 0.1);
        }

        .modal {
            display: none;
            position: fixed;
            z-index: 1000;
            left: 0;
            top: 0;
            width: 100%;
            height: 100%;
            background-color: rgba(0, 0, 0, 0.5);
        }

        .modal.show {
            display: flex;
            align-items: center;
            justify-content: center;
        }

        .modal-content {
            background-color: white;
            margin: auto;
            padding: 0;
            border-radius: 12px;
            width: 90%;
            max-width: 900px;
            max-height: 90vh;
            overflow-y: auto;
        }
    </style>
</head>

<body class="bg-gray-50">
    <!-- Navigation -->
    <nav class="gradient-bg text-white shadow-lg">
        <div class="max-w-7xl mx-auto px-4 sm:px-6 lg:px-8">
            <div class="flex justify-between items-center h-16">
                <div class="flex items-center space-x-4">
                    <img src="resources/ats-freight-logo.png" alt="ATS FREIGHT LLC" class="h-12 w-12 object-contain"
                        onerror="this.classList.add('hidden'); this.nextElementSibling.classList.remove('hidden'); this.nextElementSibling.classList.add('flex');">
                    <div
                        class="company-logo hidden w-12 h-12 bg-white rounded-lg items-center justify-center font-bold text-gray-800">
                        ATS</div>
                    <div>
                        <h1 class="text-xl font-bold">ATS FREIGHT LLC</h1>
                        <p class="text-sm opacity-90">Transportation Management System</p>
                    </div>
                </div>
                <div class="flex items-center space-x-6">
                    <a href="index.html" class="nav-item px-3 py-2 rounded-md text-sm font-medium">
                        <i class="fas fa-tachometer-alt mr-2"></i>Dashboard
                    </a>
                    <a href="loads.html" class="nav-item px-3 py-2 rounded-md text-sm font-medium">
                        <i class="fas fa-truck mr-2"></i>Loads
                    </a>
                    <span class="nav-item active px-3 py-2 rounded-md text-sm font-medium">
                        <i class="fas fa-users mr-2"></i>Drivers
                    </span>
                    <a href="settlements.html" class="nav-item px-3 py-2 rounded-md text-sm font-medium">
                        <i class="fas fa-calculator mr-2"></i>Settlements
                    </a>
                    <span class="text-sm">Welcome, Liban Ali</span>
                    <button class="nav-item px-3 py-2 rounded-md text-sm font-medium">
                        <i class="fas fa-sign-out-alt mr-2"></i>Logout
                    </button>
                </div>
            </div>
        </div>
    </nav>

    <!-- Main Content -->
    <div class="max-w-7xl mx-auto px-4 sm:px-6 lg:px-8 py-8">
        <!-- Page Header -->
        <div class="flex justify-between items-center mb-8">
            <div>
                <h2 class="text-3xl font-bold text-gray-900">Driver Management</h2>
                <p class="text-gray-600 mt-2">Manage drivers, payments, and performance</p>
            </div>
            <button onclick="openCreateDriverModal()"
                class="bg-blue-600 text-white px-6 py-3 rounded-lg hover:bg-blue-700 transition-colors">
                <i class="fas fa-plus mr-2"></i>Add New Driver
            </button>
        </div>

        <!-- Driver Stats -->
        <div class="grid grid-cols-1 md:grid-cols-4 gap-6 mb-8">
            <div class="bg-white rounded-lg p-6 card-shadow">
                <div class="flex items-center">
                    <div class="flex-shrink-0">
                        <div class="w-8 h-8 bg-green-100 rounded-lg flex items-center justify-center">
                            <i class="fas fa-user-check text-green-600"></i>
                        </div>
                    </div>
                    <div class="ml-5 w-0 flex-1">
                        <dl>
                            <dt class="text-sm font-medium text-gray-500 truncate">Active Drivers</dt>
                            <dd id="activeDriversCount" class="text-2xl font-semibold text-gray-900">0</dd>
                        </dl>
                    </div>
                </div>
            </div>

            <div class="bg-white rounded-lg p-6 card-shadow">
                <div class="flex items-center">
                    <div class="flex-shrink-0">
                        <div class="w-8 h-8 bg-yellow-100 rounded-lg flex items-center justify-center">
                            <i class="fas fa-clock text-yellow-600"></i>
                        </div>
                    </div>
                    <div class="ml-5 w-0 flex-1">
                        <dl>
                            <dt class="text-sm font-medium text-gray-500 truncate">On Time Delivery</dt>
                            <dd id="onTimeDelivery" class="text-2xl font-semibold text-gray-900">0%</dd>
                        </dl>
                    </div>
                </div>
            </div>

            <div class="bg-white rounded-lg p-6 card-shadow">
                <div class="flex items-center">
                    <div class="flex-shrink-0">
                        <div class="w-8 h-8 bg-blue-100 rounded-lg flex items-center justify-center">
                            <i class="fas fa-route text-blue-600"></i>
                        </div>
                    </div>
                    <div class="ml-5 w-0 flex-1">
                        <dl>
                            <dt class="text-sm font-medium text-gray-500 truncate">Avg Miles/Driver</dt>
                            <dd id="avgMilesPerDriver" class="text-2xl font-semibold text-gray-900">0</dd>
                        </dl>
                    </div>
                </div>
            </div>

            <div class="bg-white rounded-lg p-6 card-shadow">
                <div class="flex items-center">
                    <div class="flex-shrink-0">
                        <div class="w-8 h-8 bg-purple-100 rounded-lg flex items-center justify-center">
                            <i class="fas fa-shield-alt text-purple-600"></i>
                        </div>
                    </div>
                    <div class="ml-5 w-0 flex-1">
                        <dl>
                            <dt class="text-sm font-medium text-gray-500 truncate">Safety Score</dt>
                            <dd id="safetyScore" class="text-2xl font-semibold text-gray-900">0</dd>
                        </dl>
                    </div>
                </div>
            </div>
        </div>

        <!-- Filters -->
        <div class="bg-white rounded-lg p-6 card-shadow mb-8">
            <div class="grid grid-cols-1 md:grid-cols-4 gap-4">
                <div>
                    <label for="statusFilter" class="block text-sm font-medium text-gray-700 mb-2">Status</label>
                    <select id="statusFilter" aria-label="Filter by Status"
                        class="w-full border border-gray-300 rounded-lg px-3 py-2 focus:ring-2 focus:ring-blue-500 focus:border-transparent">
                        <option value="">All Statuses</option>
                        <option value="active">Active</option>
                        <option value="inactive">Inactive</option>
                        <option value="terminated">Terminated</option>
                    </select>
                </div>
                <div>
                    <label for="paymentFilter" class="block text-sm font-medium text-gray-700 mb-2">Payment Type</label>
                    <select id="paymentFilter" aria-label="Filter by Payment Type"
                        class="w-full border border-gray-300 rounded-lg px-3 py-2 focus:ring-2 focus:ring-blue-500 focus:border-transparent">
                        <option value="">All Types</option>
                        <option value="per_mile">Per Mile</option>
                        <option value="percentage">Percentage</option>
                        <option value="flat_rate">Flat Rate</option>
                    </select>
                </div>
                <div>
                    <label class="block text-sm font-medium text-gray-700 mb-2">Search</label>
                    <input type="text" id="searchInput" placeholder="Driver name, license #..."
                        class="w-full border border-gray-300 rounded-lg px-3 py-2 focus:ring-2 focus:ring-blue-500 focus:border-transparent">
                </div>
                <div class="flex items-end">
                    <button
                        class="w-full bg-gray-600 text-white px-4 py-2 rounded-lg hover:bg-gray-700 transition-colors">
                        <i class="fas fa-search mr-2"></i>Search
                    </button>
                </div>
            </div>
        </div>

        <!-- Drivers Table -->
        <div class="bg-white rounded-lg card-shadow">
            <div class="px-6 py-4 border-b border-gray-200">
                <div class="flex justify-between items-center">
                    <h3 class="text-lg font-semibold text-gray-900">All Drivers</h3>
                    <div class="flex items-center space-x-4">
                        <button class="text-gray-600 hover:text-gray-800">
                            <i class="fas fa-download mr-2"></i>Export
                        </button>
                        <button class="text-gray-600 hover:text-gray-800">
                            <i class="fas fa-filter mr-2"></i>Filter
                        </button>
                    </div>
                </div>
            </div>
            <div class="overflow-x-auto table-responsive table-scroll-hint">
                <table class="min-w-full divide-y divide-gray-200">
                    <thead class="bg-gray-50">
                        <tr>
                            <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">
                                Driver</th>
                            <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">
                                License</th>
                            <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">
                                Payment Type</th>
                            <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">
                                Rate</th>
                            <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">
                                Current Truck</th>
                            <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">
                                Status</th>
                            <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">
                                Performance</th>
                            <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">
                                Actions</th>
                        </tr>
                    </thead>
                    <tbody id="driversTableBody" class="bg-white divide-y divide-gray-200">
                        <!-- Drivers data will be populated from Firebase -->
                    </tbody>
                </table>
            </div>
            <div class="px-6 py-4 border-t border-gray-200">
                <div class="flex items-center justify-between">
                    <div class="text-sm text-gray-700">
                        Showing <span class="font-medium">1</span> to <span class="font-medium">4</span> of <span
                            class="font-medium">18</span> drivers
                    </div>
                    <div class="flex space-x-2">
                        <button
                            class="px-3 py-2 text-sm font-medium text-gray-500 bg-white border border-gray-300 rounded-md hover:bg-gray-50">
                            Previous
                        </button>
                        <button
                            class="px-3 py-2 text-sm font-medium text-white bg-blue-600 border border-transparent rounded-md">
                            1
                        </button>
                        <button
                            class="px-3 py-2 text-sm font-medium text-gray-500 bg-white border border-gray-300 rounded-md hover:bg-gray-50">
                            2
                        </button>
                        <button
                            class="px-3 py-2 text-sm font-medium text-gray-500 bg-white border border-gray-300 rounded-md hover:bg-gray-50">
                            3
                        </button>
                        <button
                            class="px-3 py-2 text-sm font-medium text-gray-500 bg-white border border-gray-300 rounded-md hover:bg-gray-50">
                            Next
                        </button>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Create/Edit Driver Modal -->
    <div id="driverModal" class="modal">
        <div class="modal-content">
            <div class="bg-gradient-to-r from-blue-600 to-blue-800 text-white px-6 py-4">
                <div class="flex justify-between items-center">
                    <h3 id="modalTitle" class="text-xl font-semibold">Add New Driver</h3>
                    <button onclick="closeModal()" class="text-white hover:text-gray-200">
                        <i class="fas fa-times text-xl"></i>
                    </button>
                </div>
            </div>

            <div class="p-6">
                <form id="driverForm" class="space-y-6">
                    <input type="hidden" id="driverId">
                    <!-- Basic Information -->
                    <div class="border-t pt-6">
                        <h4 class="text-lg font-semibold text-gray-900 mb-4">Basic Information</h4>
                        <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
                            <div>
                                <label class="block text-sm font-medium text-gray-700 mb-2">Driver Number</label>
                                <input type="text" id="driverNumber" readonly
                                    class="w-full border border-gray-300 rounded-lg px-3 py-2 bg-gray-50"
                                    placeholder="DRV-001">
                            </div>
                            <div>
                                <label class="block text-sm font-medium text-gray-700 mb-2">Status</label>
                                <select id="status"
                                    class="w-full border border-gray-300 rounded-lg px-3 py-2 focus:ring-2 focus:ring-blue-500 focus:border-transparent">
                                    <option value="active">Active</option>
                                    <option value="inactive">Inactive</option>
                                    <option value="on_leave">On Leave</option>
                                </select>
                            </div>
                            <div>
                                <label class="block text-sm font-medium text-gray-700 mb-2">Driver Type <span
                                        class="text-red-500">*</span></label>
                                <select id="driverType" required onchange="toggleDriverTypeFields()"
                                    class="w-full border border-gray-300 rounded-lg px-3 py-2 focus:ring-2 focus:ring-blue-500 focus:border-transparent">
                                    <option value="">Select Driver Type</option>
                                    <option value="company">Company Driver</option>
                                    <option value="owner_operator">Owner Operator</option>
                                    <option value="owner">Owner (Driver)</option>
                                </select>
                                <p class="text-xs text-gray-500 mt-1">
                                    <strong>Company Driver:</strong> Custom percentage or per-mile rate, all expenses
                                    paid by
                                    company<br>
                                    <strong>Owner Operator:</strong> Custom percentage, expenses may be deducted from
                                    settlement<br>
                                    <strong>Owner (Driver):</strong> Same as company driver, gets business profit
                                    separately
                                </p>
                            </div>
                            <div>
                                <label class="block text-sm font-medium text-gray-700 mb-2">Current Truck</label>
                                <select id="currentTruckId"
                                    class="w-full border border-gray-300 rounded-lg px-3 py-2 focus:ring-2 focus:ring-blue-500 focus:border-transparent">
                                    <option value="">No truck assigned</option>
                                </select>
                                <p class="text-xs text-gray-500 mt-1">
                                    Assign this driver to a specific truck. This will auto-fill truck fields in forms.
                                </p>
                            </div>
                        </div>
                    </div>

                    <!-- Personal Information -->
                    <div class="border-t pt-6">
                        <h4 class="text-lg font-semibold text-gray-900 mb-4">Personal Information</h4>
                        <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
                            <div>
                                <label class="block text-sm font-medium text-gray-700 mb-2">First Name</label>
                                <input type="text" id="firstName" required
                                    class="w-full border border-gray-300 rounded-lg px-3 py-2 focus:ring-2 focus:ring-blue-500 focus:border-transparent"
                                    placeholder="John">
                            </div>
                            <div>
                                <label class="block text-sm font-medium text-gray-700 mb-2">Last Name</label>
                                <input type="text" id="lastName" required
                                    class="w-full border border-gray-300 rounded-lg px-3 py-2 focus:ring-2 focus:ring-blue-500 focus:border-transparent"
                                    placeholder="Doe">
                            </div>
                            <div>
                                <label class="block text-sm font-medium text-gray-700 mb-2">Date of Birth</label>
                                <input type="date" id="dob"
                                    class="w-full border border-gray-300 rounded-lg px-3 py-2 focus:ring-2 focus:ring-blue-500 focus:border-transparent">
                            </div>
                            <div>
                                <label class="block text-sm font-medium text-gray-700 mb-2">SSN</label>
                                <input type="text" id="ssn"
                                    class="w-full border border-gray-300 rounded-lg px-3 py-2 focus:ring-2 focus:ring-blue-500 focus:border-transparent"
                                    placeholder="***-**-6789">
                            </div>
                            <div>
                                <label class="block text-sm font-medium text-gray-700 mb-2">Phone</label>
                                <input type="tel" id="phone" required
                                    class="w-full border border-gray-300 rounded-lg px-3 py-2 focus:ring-2 focus:ring-blue-500 focus:border-transparent"
                                    placeholder="(614) 555-0123">
                            </div>
                            <div>
                                <label class="block text-sm font-medium text-gray-700 mb-2">Email</label>
                                <input type="email" id="email" required
                                    class="w-full border border-gray-300 rounded-lg px-3 py-2 focus:ring-2 focus:ring-blue-500 focus:border-transparent"
                                    placeholder="john@email.com">
                            </div>
                        </div>
                        <div class="grid grid-cols-1 md:grid-cols-3 gap-4 mt-4">
                            <div class="md:col-span-2">
                                <label class="block text-sm font-medium text-gray-700 mb-2">Address</label>
                                <input type="text" id="address"
                                    class="w-full border border-gray-300 rounded-lg px-3 py-2 focus:ring-2 focus:ring-blue-500 focus:border-transparent"
                                    placeholder="123 Main St">
                            </div>
                            <div>
                                <label class="block text-sm font-medium text-gray-700 mb-2">City</label>
                                <input type="text" id="city"
                                    class="w-full border border-gray-300 rounded-lg px-3 py-2 focus:ring-2 focus:ring-blue-500 focus:border-transparent"
                                    placeholder="Columbus">
                            </div>
                        </div>
                        <div class="grid grid-cols-1 md:grid-cols-2 gap-4 mt-4">
                            <div>
                                <label class="block text-sm font-medium text-gray-700 mb-2">State</label>
                                <select id="state"
                                    class="w-full border border-gray-300 rounded-lg px-3 py-2 focus:ring-2 focus:ring-blue-500 focus:border-transparent">
                                    <option value="">Select State</option>
                                    <option value="OH">Ohio</option>
                                    <option value="AL">Alabama</option>
                                    <option value="AK">Alaska</option>
                                    <option value="AZ">Arizona</option>
                                    <option value="AR">Arkansas</option>
                                    <option value="CA">California</option>
                                    <option value="CO">Colorado</option>
                                    <option value="CT">Connecticut</option>
                                    <option value="DE">Delaware</option>
                                    <option value="FL">Florida</option>
                                    <option value="GA">Georgia</option>
                                    <option value="HI">Hawaii</option>
                                    <option value="ID">Idaho</option>
                                    <option value="IL">Illinois</option>
                                    <option value="IN">Indiana</option>
                                    <option value="IA">Iowa</option>
                                    <option value="KS">Kansas</option>
                                    <option value="KY">Kentucky</option>
                                    <option value="LA">Louisiana</option>
                                    <option value="ME">Maine</option>
                                    <option value="MD">Maryland</option>
                                    <option value="MA">Massachusetts</option>
                                    <option value="MI">Michigan</option>
                                    <option value="MN">Minnesota</option>
                                    <option value="MS">Mississippi</option>
                                    <option value="MO">Missouri</option>
                                    <option value="MT">Montana</option>
                                    <option value="NE">Nebraska</option>
                                    <option value="NV">Nevada</option>
                                    <option value="NH">New Hampshire</option>
                                    <option value="NJ">New Jersey</option>
                                    <option value="NM">New Mexico</option>
                                    <option value="NY">New York</option>
                                    <option value="NC">North Carolina</option>
                                    <option value="ND">North Dakota</option>
                                    <option value="OK">Oklahoma</option>
                                    <option value="OR">Oregon</option>
                                    <option value="PA">Pennsylvania</option>
                                    <option value="RI">Rhode Island</option>
                                    <option value="SC">South Carolina</option>
                                    <option value="SD">South Dakota</option>
                                    <option value="TN">Tennessee</option>
                                    <option value="TX">Texas</option>
                                    <option value="UT">Utah</option>
                                    <option value="VT">Vermont</option>
                                    <option value="VA">Virginia</option>
                                    <option value="WA">Washington</option>
                                    <option value="WV">West Virginia</option>
                                    <option value="WI">Wisconsin</option>
                                    <option value="WY">Wyoming</option>
                                </select>
                            </div>
                            <div>
                                <label class="block text-sm font-medium text-gray-700 mb-2">ZIP Code</label>
                                <input type="text" id="zipCode"
                                    class="w-full border border-gray-300 rounded-lg px-3 py-2 focus:ring-2 focus:ring-blue-500 focus:border-transparent"
                                    placeholder="43215">
                            </div>
                        </div>
                    </div>

                    <!-- License Information -->
                    <div class="border-t pt-6">
                        <h4 class="text-lg font-semibold text-gray-900 mb-4">License Information</h4>
                        <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
                            <div>
                                <label class="block text-sm font-medium text-gray-700 mb-2">License Number</label>
                                <input type="text" id="licenseNumber"
                                    class="w-full border border-gray-300 rounded-lg px-3 py-2 focus:ring-2 focus:ring-blue-500 focus:border-transparent"
                                    placeholder="DL123456789">
                            </div>
                            <div>
                                <label class="block text-sm font-medium text-gray-700 mb-2">License State</label>
                                <select id="licenseState"
                                    class="w-full border border-gray-300 rounded-lg px-3 py-2 focus:ring-2 focus:ring-blue-500 focus:border-transparent">
                                    <option value="">Select State</option>
                                    <option value="OH">Ohio</option>
                                    <option value="AL">Alabama</option>
                                    <option value="AK">Alaska</option>
                                    <option value="AZ">Arizona</option>
                                    <option value="AR">Arkansas</option>
                                    <option value="CA">California</option>
                                    <option value="CO">Colorado</option>
                                    <option value="CT">Connecticut</option>
                                    <option value="DE">Delaware</option>
                                    <option value="FL">Florida</option>
                                    <option value="GA">Georgia</option>
                                    <option value="HI">Hawaii</option>
                                    <option value="ID">Idaho</option>
                                    <option value="IL">Illinois</option>
                                    <option value="IN">Indiana</option>
                                    <option value="IA">Iowa</option>
                                    <option value="KS">Kansas</option>
                                    <option value="KY">Kentucky</option>
                                    <option value="LA">Louisiana</option>
                                    <option value="ME">Maine</option>
                                    <option value="MD">Maryland</option>
                                    <option value="MA">Massachusetts</option>
                                    <option value="MI">Michigan</option>
                                    <option value="MN">Minnesota</option>
                                    <option value="MS">Mississippi</option>
                                    <option value="MO">Missouri</option>
                                    <option value="MT">Montana</option>
                                    <option value="NE">Nebraska</option>
                                    <option value="NV">Nevada</option>
                                    <option value="NH">New Hampshire</option>
                                    <option value="NJ">New Jersey</option>
                                    <option value="NM">New Mexico</option>
                                    <option value="NY">New York</option>
                                    <option value="NC">North Carolina</option>
                                    <option value="ND">North Dakota</option>
                                    <option value="OK">Oklahoma</option>
                                    <option value="OR">Oregon</option>
                                    <option value="PA">Pennsylvania</option>
                                    <option value="RI">Rhode Island</option>
                                    <option value="SC">South Carolina</option>
                                    <option value="SD">South Dakota</option>
                                    <option value="TN">Tennessee</option>
                                    <option value="TX">Texas</option>
                                    <option value="UT">Utah</option>
                                    <option value="VT">Vermont</option>
                                    <option value="VA">Virginia</option>
                                    <option value="WA">Washington</option>
                                    <option value="WV">West Virginia</option>
                                    <option value="WI">Wisconsin</option>
                                    <option value="WY">Wyoming</option>
                                </select>
                            </div>
                            <div>
                                <label class="block text-sm font-medium text-gray-700 mb-2">License Expiration
                                    Date</label>
                                <input type="date" id="licenseExpiration"
                                    class="w-full border border-gray-300 rounded-lg px-3 py-2 focus:ring-2 focus:ring-blue-500 focus:border-transparent">
                            </div>
                            <div>
                                <label class="block text-sm font-medium text-gray-700 mb-2">Medical Card Expiration Date
                                    <span class="text-red-500">*</span></label>
                                <input type="date" id="medicalExpirationDate" required
                                    class="w-full border border-gray-300 rounded-lg px-3 py-2 focus:ring-2 focus:ring-blue-500 focus:border-transparent">
                                <p class="text-xs text-gray-500 mt-1">Required for FMCSA compliance</p>
                            </div>
                            <div>
                                <label class="block text-sm font-medium text-gray-700 mb-2">License Class</label>
                                <select id="licenseClass"
                                    class="w-full border border-gray-300 rounded-lg px-3 py-2 focus:ring-2 focus:ring-blue-500 focus:border-transparent">
                                    <option value="">Select Class</option>
                                    <option value="CDL-A">CDL-A</option>
                                    <option value="CDL-B">CDL-B</option>
                                    <option value="CDL-C">CDL-C</option>
                                </select>
                            </div>
                            <div>
                                <label class="block text-sm font-medium text-gray-700 mb-2">Endorsements</label>
                                <input type="text" id="endorsements"
                                    class="w-full border border-gray-300 rounded-lg px-3 py-2 focus:ring-2 focus:ring-blue-500 focus:border-transparent"
                                    placeholder="H, T, N">
                            </div>
                        </div>
                    </div>

                    <!-- Payment Configuration -->
                    <div class="border-t pt-6">
                        <h4 class="text-lg font-semibold text-gray-900 mb-4">Payment Configuration</h4>
                        <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
                            <div>
                                <label class="block text-sm font-medium text-gray-700 mb-2">Payment Type</label>
                                <select id="paymentType" onchange="togglePaymentFields()"
                                    class="w-full border border-gray-300 rounded-lg px-3 py-2 focus:ring-2 focus:ring-blue-500 focus:border-transparent">
                                    <option value="">Select Type</option>
                                    <option value="per_mile">Per Mile</option>
                                    <option value="percentage">Percentage</option>
                                    <option value="flat_rate">Flat Rate</option>
                                </select>
                            </div>
                            <div id="perMileField" class="hidden">
                                <label class="block text-sm font-medium text-gray-700 mb-2">Rate Per Mile</label>
                                <input type="number" id="ratePerMile" step="0.01"
                                    class="w-full border border-gray-300 rounded-lg px-3 py-2 focus:ring-2 focus:ring-blue-500 focus:border-transparent"
                                    placeholder="0.00">
                            </div>
                            <div id="percentageField" class="hidden">
                                <label class="block text-sm font-medium text-gray-700 mb-2">Percentage Rate</label>
                                <input type="number" id="percentageRate" step="0.01" min="0" max="100"
                                    class="w-full border border-gray-300 rounded-lg px-3 py-2 focus:ring-2 focus:ring-blue-500 focus:border-transparent"
                                    placeholder="Enter percentage (required)" required min="0.01">
                                <p class="text-xs text-gray-500 mt-1" id="percentageHint">
                                    Enter driver's specific percentage (e.g., 65 for 65%)
                                </p>
                            </div>
                        </div>
                        <div class="grid grid-cols-1 md:grid-cols-3 gap-4 mt-4">
                            <div>
                                <label class="block text-sm font-medium text-gray-700 mb-2">Detention Pay</label>
                                <input type="number" id="detentionPay" step="0.01"
                                    class="w-full border border-gray-300 rounded-lg px-3 py-2 focus:ring-2 focus:ring-blue-500 focus:border-transparent"
                                    placeholder="25.00">
                            </div>
                            <div>
                                <label class="block text-sm font-medium text-gray-700 mb-2">Layover Pay</label>
                                <input type="number" id="layoverPay" step="0.01"
                                    class="w-full border border-gray-300 rounded-lg px-3 py-2 focus:ring-2 focus:ring-blue-500 focus:border-transparent"
                                    placeholder="100.00">
                            </div>
                            <div class="flex items-center pt-6">
                                <input type="checkbox" id="fuelSurcharge"
                                    class="h-4 w-4 text-blue-600 focus:ring-blue-500 border-gray-300 rounded">
                                <label for="fuelSurcharge" class="ml-2 block text-sm text-gray-900">Fuel
                                    Surcharge</label>
                            </div>
                        </div>
                    </div>

                    <!-- Owner Operator Deduction Preferences -->
                    <div id="deductionPreferencesSection" class="border-t pt-6 hidden">
                        <h4 class="text-lg font-semibold text-gray-900 mb-4">Deduction Preferences (Owner Operator Only)
                        </h4>
                        <p class="text-sm text-gray-600 mb-4">Select which expenses should be deducted from settlement.
                            Unchecked items are paid outside the system.</p>
                        <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
                            <div class="flex items-center p-3 bg-gray-50 rounded-lg">
                                <input type="checkbox" id="deductFuel"
                                    class="h-4 w-4 text-blue-600 focus:ring-blue-500 border-gray-300 rounded">
                                <label for="deductFuel" class="ml-3 block text-sm text-gray-900">
                                    <span class="font-medium">Fuel</span>
                                    <span class="text-gray-500 block text-xs">Deduct fuel expenses from
                                        settlement</span>
                                </label>
                            </div>
                            <div class="flex items-center p-3 bg-gray-50 rounded-lg">
                                <input type="checkbox" id="deductInsurance"
                                    class="h-4 w-4 text-blue-600 focus:ring-blue-500 border-gray-300 rounded">
                                <label for="deductInsurance" class="ml-3 block text-sm text-gray-900">
                                    <span class="font-medium">Insurance</span>
                                    <span class="text-gray-500 block text-xs">Deduct insurance expenses from
                                        settlement</span>
                                </label>
                            </div>
                            <div class="flex items-center p-3 bg-gray-50 rounded-lg">
                                <input type="checkbox" id="deductMaintenance"
                                    class="h-4 w-4 text-blue-600 focus:ring-blue-500 border-gray-300 rounded">
                                <label for="deductMaintenance" class="ml-3 block text-sm text-gray-900">
                                    <span class="font-medium">Maintenance</span>
                                    <span class="text-gray-500 block text-xs">Deduct maintenance expenses from
                                        settlement</span>
                                </label>
                            </div>
                            <div class="flex items-center p-3 bg-gray-50 rounded-lg">
                                <input type="checkbox" id="deductOther"
                                    class="h-4 w-4 text-blue-600 focus:ring-blue-500 border-gray-300 rounded">
                                <label for="deductOther" class="ml-3 block text-sm text-gray-900">
                                    <span class="font-medium">Other Expenses</span>
                                    <span class="text-gray-500 block text-xs">Deduct other expenses from
                                        settlement</span>
                                </label>
                            </div>
                        </div>
                    </div>

                    <!-- Employment Information -->
                    <div class="border-t pt-6">
                        <h4 class="text-lg font-semibold text-gray-900 mb-4">Employment Information</h4>
                        <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
                            <div>
                                <label class="block text-sm font-medium text-gray-700 mb-2">Status</label>
                                <select id="employmentStatus"
                                    class="w-full border border-gray-300 rounded-lg px-3 py-2 focus:ring-2 focus:ring-blue-500 focus:border-transparent">
                                    <option value="active">Active</option>
                                    <option value="inactive">Inactive</option>
                                    <option value="terminated">Terminated</option>
                                </select>
                            </div>
                            <div>
                                <label class="block text-sm font-medium text-gray-700 mb-2">Hire Date</label>
                                <input type="date" id="hireDate"
                                    class="w-full border border-gray-300 rounded-lg px-3 py-2 focus:ring-2 focus:ring-blue-500 focus:border-transparent">
                            </div>
                            <div>
                                <label class="block text-sm font-medium text-gray-700 mb-2">Pay Frequency</label>
                                <select id="payFrequency"
                                    class="w-full border border-gray-300 rounded-lg px-3 py-2 focus:ring-2 focus:ring-blue-500 focus:border-transparent">
                                    <option value="weekly">Weekly</option>
                                    <option value="bi-weekly">Bi-Weekly</option>
                                    <option value="monthly">Monthly</option>
                                </select>
                            </div>
                            <div>
                                <label class="block text-sm font-medium text-gray-700 mb-2">W-4 Exemptions</label>
                                <input type="number" id="w4Exemptions"
                                    class="w-full border border-gray-300 rounded-lg px-3 py-2 focus:ring-2 focus:ring-blue-500 focus:border-transparent"
                                    placeholder="2">
                            </div>
                        </div>
                    </div>

                    <!-- Emergency Contact -->
                    <div class="border-t pt-6">
                        <h4 class="text-lg font-semibold text-gray-900 mb-4">Emergency Contact</h4>
                        <div class="grid grid-cols-1 md:grid-cols-3 gap-4">
                            <div>
                                <label class="block text-sm font-medium text-gray-700 mb-2">Contact Name</label>
                                <input type="text" id="emergencyName"
                                    class="w-full border border-gray-300 rounded-lg px-3 py-2 focus:ring-2 focus:ring-blue-500 focus:border-transparent"
                                    placeholder="Jane Doe">
                            </div>
                            <div>
                                <label class="block text-sm font-medium text-gray-700 mb-2">Relationship</label>
                                <input type="text" id="emergencyRelationship"
                                    class="w-full border border-gray-300 rounded-lg px-3 py-2 focus:ring-2 focus:ring-blue-500 focus:border-transparent"
                                    placeholder="Spouse">
                            </div>
                            <div>
                                <label class="block text-sm font-medium text-gray-700 mb-2">Phone</label>
                                <input type="tel" id="emergencyPhone"
                                    class="w-full border border-gray-300 rounded-lg px-3 py-2 focus:ring-2 focus:ring-blue-500 focus:border-transparent"
                                    placeholder="(614) 555-0123">
                            </div>
                        </div>
                    </div>

                    <!-- Form Actions -->
                    <div class="border-t pt-6 flex justify-end space-x-4">
                        <button type="button" onclick="closeModal()"
                            class="px-6 py-2 border border-gray-300 rounded-lg text-gray-700 hover:bg-gray-50 transition-colors">
                            Cancel
                        </button>
                        <button type="submit"
                            class="px-6 py-2 bg-blue-600 text-white rounded-lg hover:bg-blue-700 transition-colors">
                            Save Driver
                        </button>
                    </div>
                </form>
            </div>
        </div>
    </div>

    <!-- Footer -->
    <footer class="mt-12 py-8 border-t border-gray-200">
        <div class="text-center">
            <p class="text-gray-600">&copy; 2025 ATS FREIGHT LLC. All rights reserved.</p>
            <p class="text-sm text-gray-500 mt-2">3191 MORSE RD STE 15, COLUMBUS, OH 43231 | (614) 254-0380 | DOT
                3169186</p>
            <p class="text-sm text-gray-500 mt-2">3191 MORSE RD STE 15, COLUMBUS, OH 43231 | (614) 254-0380</p>
        </div>
    </footer>

    <!-- Firebase SDK -->
    <script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-firestore-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-auth-compat.js"></script>

    <script src="data-stability.js"></script>
    <script src="main.js"></script>
    <script src="populate-mock-data.js"></script>
    <script>
        let currentDriverId = null;

        // Initialize
        document.addEventListener('DOMContentLoaded', async () => {
            // Wait for main.js to load
            if (typeof Auth === 'undefined' || typeof DataManager === 'undefined') {
                console.error('Auth or DataManager not loaded. Make sure main.js is loaded first.');
                Utils.showNotification('Error: Required scripts not loaded. Please refresh the page.', 'error');
                return;
            }

            Auth.init();
            await DataManager.init();

            // Check for filter from dashboard navigation
            const savedFilter = localStorage.getItem('driversFilter');
            if (savedFilter) {
                try {
                    const filter = JSON.parse(savedFilter);
                    // Apply status filter if present
                    if (filter.status) {
                        const statusFilter = document.getElementById('statusFilter');
                        if (statusFilter) {
                            statusFilter.value = filter.status;
                            Utils.showNotification('Showing active drivers only', 'info');
                            // Trigger re-render with the filter applied
                            setTimeout(() => renderDrivers(), 100);
                        }
                    }
                    // Clear the filter after applying
                    localStorage.removeItem('driversFilter');
                } catch (e) {
                    console.error('Error parsing drivers filter:', e);
                }
            }

            // Add a small delay to ensure all data is loaded
            setTimeout(() => {
                renderDrivers();
                updateDriverStats();
            }, 200);
        });

        function updateDriverStats() {
            const drivers = DataManager.drivers || [];
            const loads = DataManager.loads || [];

            // Count active drivers
            const activeDrivers = drivers.filter(d => d.status === 'active').length;

            // Calculate on-time delivery percentage
            const deliveredLoads = loads.filter(l => l.status === 'delivered' || l.status === 'completed');
            const onTimeLoads = deliveredLoads.filter(l => {
                // Consider on-time if delivered before or on delivery date
                if (!l.delivery?.date || !l.actualDeliveryDate) return true;
                return new Date(l.actualDeliveryDate) <= new Date(l.delivery.date);
            });
            const onTimePercentage = deliveredLoads.length > 0
                ? Math.round((onTimeLoads.length / deliveredLoads.length) * 100)
                : 0;

            // Calculate average miles per driver
            const totalMiles = loads.reduce((sum, l) => sum + (parseFloat(l.mileage?.total || l.totalMiles || 0)), 0);
            const avgMiles = activeDrivers > 0 ? Math.round(totalMiles / activeDrivers) : 0;

            // Calculate safety score (placeholder - would need actual incident data)
            // For now, use a simple calculation based on completed loads without incidents
            const safetyScore = deliveredLoads.length > 0 ? 98.5 : 0;

            // Update UI
            document.getElementById('activeDriversCount').textContent = activeDrivers;
            document.getElementById('onTimeDelivery').textContent = onTimePercentage + '%';
            document.getElementById('avgMilesPerDriver').textContent = avgMiles.toLocaleString();
            document.getElementById('safetyScore').textContent = safetyScore.toFixed(1);
        }

        function renderDrivers() {
            const tbody = document.getElementById('driversTableBody');
            tbody.innerHTML = '';

            // If trucks aren't loaded yet, schedule a re-render
            if (!DataManager || !DataManager.trucks || DataManager.trucks.length === 0) {
                console.log('Trucks not loaded yet, will re-render in 500ms...');
                setTimeout(() => {
                    if (DataManager && DataManager.trucks && DataManager.trucks.length > 0) {
                        renderDrivers();
                    }
                }, 500);
            }

            const statusFilter = document.getElementById('statusFilter').value;
            const paymentFilter = document.getElementById('paymentFilter').value;
            const searchInput = document.getElementById('searchInput').value.toLowerCase();

            const filteredDrivers = DataManager.drivers.filter(driver => {
                const matchesStatus = !statusFilter || driver.status === statusFilter;
                const matchesPayment = !paymentFilter || driver.payment.type === paymentFilter;
                const matchesSearch = !searchInput ||
                    driver.firstName.toLowerCase().includes(searchInput) ||
                    driver.lastName.toLowerCase().includes(searchInput) ||
                    driver.driverNumber.toLowerCase().includes(searchInput);

                return matchesStatus && matchesPayment && matchesSearch;
            });

            filteredDrivers.forEach(driver => {
                const statusClass = {
                    'active': 'status-active',
                    'inactive': 'status-inactive',
                    'on_leave': 'status-warning'
                }[driver.status] || 'bg-gray-500';

                const tr = document.createElement('tr');
                tr.innerHTML = `
                    <td class="px-6 py-4 whitespace-nowrap">
                        <div class="flex items-center">
                            <div class="h-10 w-10 rounded-full bg-gray-200 flex items-center justify-center text-gray-500 font-bold">
                                ${(driver.firstName?.[0] || '')}${(driver.lastName?.[0] || '')}
                            </div>
                            <div class="ml-4">
                                <div class="text-sm font-medium text-gray-900">${driver.firstName || ''} ${driver.lastName || ''}</div>
                                <div class="text-sm text-gray-500">${driver.driverNumber || ''}</div>
                            </div>
                        </div>
                    </td>
                    <td class="px-6 py-4 whitespace-nowrap">
                        <div class="text-sm text-gray-900">${driver.license?.number || 'N/A'}</div>
                        <div class="text-sm text-gray-500">${driver.license?.state || ''} ${driver.license?.expiration ? 'Exp: ' + driver.license.expiration : ''}</div>
                    </td>
                    <td class="px-6 py-4 whitespace-nowrap">
                        <div class="text-sm text-gray-900">
                            ${driver.driverType === 'company' ? 'Company Driver' :
                        driver.driverType === 'owner_operator' ? 'Owner Operator' :
                            driver.driverType === 'owner' ? 'Owner (Driver)' : 'N/A'}
                        </div>
                        <div class="text-xs text-gray-500">
                            ${driver.payment?.type === 'per_mile' ? 'Per Mile' : driver.payment?.type === 'percentage' ? 'Percentage' : driver.payment?.type === 'flat_rate' ? 'Flat Rate' : 'Unknown'}
                        </div>
                    </td>
                    <td class="px-6 py-4 whitespace-nowrap">
                        <div class="text-sm text-gray-900">${driver.payment?.type === 'per_mile' ? Utils.formatCurrency(driver.payment?.perMileRate || 0) + '/mi' : driver.payment?.type === 'percentage' ? ((driver.payPercentage || 0) > 1 ? (driver.payPercentage || 0) : (driver.payPercentage || 0) * 100).toFixed(0) + '%' : driver.payment?.type === 'flat_rate' ? Utils.formatCurrency(driver.payment?.flatRate || 0) + '/load' : '-'}</div>
                    </td>
                    <td class="px-6 py-4 whitespace-nowrap">
                        <span class="inline-flex px-2 py-1 text-xs font-semibold rounded-full text-white ${statusClass}">
                            ${(driver.status || 'unknown').replace('_', ' ').toUpperCase()}
                        </span>
                    </td>
                    <td class="px-6 py-4 whitespace-nowrap">
                        <div class="text-sm text-gray-900">${getCurrentTruckDisplay(driver.currentTruckId)}</div>
                    </td>
                    <td class="px-6 py-4 whitespace-nowrap">
                        <div class="text-sm text-gray-900">${driver.phone || 'N/A'}</div>
                        <div class="text-sm text-gray-500">${driver.email || 'N/A'}</div>
                    </td>
                    <td class="px-6 py-4 whitespace-nowrap text-sm font-medium">
                        <button onclick="editDriver('${driver.id}')" class="text-blue-600 hover:text-blue-900 mr-3">
                            <i class="fas fa-edit"></i>
                        </button>
                        <button onclick="viewDriver('${driver.id}')" class="text-green-600 hover:text-green-900 mr-3">
                            <i class="fas fa-eye"></i>
                        </button>
                        <button onclick="deleteDriver('${driver.id}')" class="text-red-600 hover:text-red-900">
                            <i class="fas fa-trash"></i>
                        </button>
                    </td>
                `;
                tbody.appendChild(tr);
            });
        }

        function openCreateDriverModal() {
            if (typeof DataManager === 'undefined') {
                console.error('DataManager not loaded');
                Utils.showNotification('Error: System not initialized. Please refresh the page.', 'error');
                return;
            }

            document.getElementById('driverForm').reset();
            document.getElementById('driverId').value = ''; // Clear ID for new driver
            document.getElementById('modalTitle').textContent = 'Add New Driver';

            // Generate new driver number
            if (typeof DataManager !== 'undefined' && DataManager.drivers) {
                const nextNum = DataManager.drivers.length + 101;
                document.getElementById('driverNumber').value = 'DRV-' + nextNum;
            } else {
                document.getElementById('driverNumber').value = 'DRV-101';
            }

            // Populate truck dropdown
            populateTruckDropdown();

            document.getElementById('driverModal').classList.add('show');
        }

        function closeModal() {
            document.getElementById('driverModal').classList.remove('show');
        }

        // Expose functions to global scope for onclick handlers
        window.openCreateDriverModal = openCreateDriverModal;
        window.closeModal = closeModal;

        function editDriver(driverId) {
            const driver = DataManager.getDriver(driverId);
            if (!driver) return;

            // Set hidden ID field for save handler
            document.getElementById('driverId').value = driverId;

            document.getElementById('modalTitle').textContent = 'Edit Driver - ' + driver.driverNumber;

            // Populate form
            document.getElementById('firstName').value = driver.firstName;
            document.getElementById('lastName').value = driver.lastName;
            document.getElementById('driverNumber').value = driver.driverNumber;
            document.getElementById('status').value = driver.status;
            document.getElementById('dob').value = driver.dob || '';
            document.getElementById('ssn').value = driver.ssn || '';
            document.getElementById('phone').value = driver.phone;
            document.getElementById('email').value = driver.email;
            document.getElementById('address').value = driver.address || '';

            document.getElementById('licenseNumber').value = driver.license.number;
            document.getElementById('licenseState').value = driver.license.state;
            document.getElementById('licenseExpiration').value = driver.license.expiration;
            document.getElementById('medicalExpirationDate').value = driver.medicalExpirationDate || '';

            // Set driver type and toggle fields
            document.getElementById('driverType').value = driver.driverType || '';
            toggleDriverTypeFields();

            document.getElementById('paymentType').value = driver.payment.type;
            togglePaymentFields();
            if (driver.payment.type === 'per_mile') {
                document.getElementById('ratePerMile').value = driver.payment.perMileRate || '';
            } else if (driver.payment.type === 'percentage') {
                // Display payPercentage as percentage (multiply by 100 if stored as decimal)
                const displayPercentage = driver.payPercentage
                    ? (driver.payPercentage > 1 ? driver.payPercentage : driver.payPercentage * 100)
                    : '';
                document.getElementById('percentageRate').value = displayPercentage;
            } else if (driver.payment.type === 'flat_rate') {
                document.getElementById('ratePerMile').value = driver.payment.flatRate || '';
            }

            // Populate deduction preferences for Owner Operators
            if (driver.driverType === 'owner_operator' && driver.deductionPreferences) {
                document.getElementById('deductFuel').checked = driver.deductionPreferences.fuel || false;
                document.getElementById('deductInsurance').checked = driver.deductionPreferences.insurance || false;
                document.getElementById('deductMaintenance').checked = driver.deductionPreferences.maintenance || false;
                document.getElementById('deductOther').checked = driver.deductionPreferences.other || false;
            }

            document.getElementById('hireDate').value = driver.hireDate || '';

            // Populate truck dropdown and set current truck
            populateTruckDropdown();
            document.getElementById('currentTruckId').value = driver.currentTruckId || '';

            document.getElementById('driverModal').classList.add('show');
        }

        function viewDriver(driverId) {
            const driver = DataManager.getDriver(driverId);
            if (!driver) return;

            const content = `
                DRIVER PROFILE: ${driver.firstName} ${driver.lastName}
                --------------------------------
                ID: ${driver.driverNumber}
                Status: ${driver.status}
                
                CONTACT:
                Phone: ${driver.phone}
                Email: ${driver.email}
                
                LICENSE:
                Number: ${driver.license.number} (${driver.license.state})
                Expires: ${driver.license.expiration}
                
                PAYMENT:
                Type: ${driver.payment.type}
                Rate: ${driver.payment.type === 'per_mile' ? Utils.formatCurrency(driver.payment.perMileRate) + '/mi' : ((driver.payPercentage || 0) > 1 ? (driver.payPercentage || 0) : (driver.payPercentage || 0) * 100).toFixed(0) + '%'}
            `;
            alert(content);
        }

        async function deleteDriver(driverId) {
            if (confirm('Are you sure you want to delete this driver?')) {
                await DataManager.deleteDriver(driverId);
                Utils.logActivity('Driver Deleted', 'Driver record deleted', 'driver');
                renderDrivers();
                updateDriverStats();
                updateStats();
            }
        }

        // Populate truck dropdown
        function populateTruckDropdown() {
            const truckSelect = document.getElementById('currentTruckId');
            truckSelect.innerHTML = '<option value="">No truck assigned</option>';

            if (DataManager && DataManager.trucks) {
                DataManager.trucks.forEach(truck => {
                    const option = document.createElement('option');
                    option.value = truck.id;
                    option.textContent = `${truck.truckNumber} - ${truck.make} ${truck.model} (${truck.year})`;
                    truckSelect.appendChild(option);
                });
            }
        }

        // Get truck display for table
        function getCurrentTruckDisplay(truckId) {
            if (!truckId) {
                return '<span class="text-gray-400">No truck assigned</span>';
            }

            // Wait for DataManager to be initialized
            if (!DataManager || !DataManager.trucks || DataManager.trucks.length === 0) {
                // Return a loading state or try to find truck by ID in a different way
                return `<span class="text-blue-400">Loading truck info...</span>`;
            }

            const truck = DataManager.trucks.find(t => t.id === truckId);
            if (!truck) {
                // Try to show the truck ID at least, in case data is still loading
                return `<span class="text-orange-400">Truck ${truckId.slice(-4)} (loading...)</span>`;
            }

            return `${truck.truckNumber} - ${truck.make} ${truck.model}`;
        }

        // Expose driver action functions to global scope
        window.editDriver = editDriver;
        window.deleteDriver = deleteDriver;

        // Expose render function for external updates
        window.renderDrivers = renderDrivers;

        function toggleDriverTypeFields() {
            const driverType = document.getElementById('driverType').value;
            const deductionSection = document.getElementById('deductionPreferencesSection');
            const percentageField = document.getElementById('percentageField');
            const percentageHint = document.getElementById('percentageHint');

            // Show/hide deduction preferences section for Owner Operators
            if (driverType === 'owner_operator') {
                deductionSection.classList.remove('hidden');
                // Set default percentage range hint for owner operators
                if (percentageHint) {
                    percentageHint.textContent = 'Enter percentage (typically 85-90% for Owner Operators)';
                }
            } else {
                deductionSection.classList.add('hidden');
                // Set default percentage range hint for company drivers
                if (percentageHint) {
                    if (driverType === 'company') {
                        percentageHint.textContent = 'Enter this driver\'s specific percentage (varies by driver)';
                    } else if (driverType === 'owner') {
                        percentageHint.textContent = 'Enter this driver\'s specific percentage (varies by driver)';
                    } else {
                        percentageHint.textContent = 'Enter this driver\'s specific percentage (varies by driver)';
                    }
                }
            }
        }

        function togglePaymentFields() {
            const type = document.getElementById('paymentType').value;
            if (type === 'per_mile' || type === 'flat_rate') {
                document.getElementById('perMileField').classList.remove('hidden');
                document.getElementById('percentageField').classList.add('hidden');
                // Update label for flat rate
                if (type === 'flat_rate') {
                    document.querySelector('#perMileField label').textContent = 'Flat Rate Per Load';
                    document.getElementById('ratePerMile').placeholder = '500.00';
                } else {
                    document.querySelector('#perMileField label').textContent = 'Rate Per Mile';
                    document.getElementById('ratePerMile').placeholder = '0.00';
                }
            } else if (type === 'percentage') {
                document.getElementById('perMileField').classList.add('hidden');
                document.getElementById('percentageField').classList.remove('hidden');
            } else {
                document.getElementById('perMileField').classList.add('hidden');
                document.getElementById('percentageField').classList.add('hidden');
            }
        }

        // Filters
        document.getElementById('statusFilter').addEventListener('change', renderDrivers);
        document.getElementById('paymentFilter').addEventListener('change', renderDrivers);
        document.getElementById('searchInput').addEventListener('input', renderDrivers);
        document.getElementById('paymentType').addEventListener('change', togglePaymentFields);
        document.getElementById('driverType').addEventListener('change', toggleDriverTypeFields);

        // Expose toggleDriverTypeFields to global scope
        window.toggleDriverTypeFields = toggleDriverTypeFields;

        // Form submission
        window.driverForm_handler = async function (e) {
            // e.preventDefault() is handled by main.js universal listener

            const submitBtn = document.querySelector('#driverForm button[type="submit"]');
            const originalText = submitBtn.textContent;
            submitBtn.disabled = true;
            submitBtn.textContent = 'Saving...';

            try {
                const driverType = document.getElementById('driverType').value;
                if (!driverType) {
                    Utils.showNotification('Please select a Driver Type', 'error');
                    submitBtn.disabled = false;
                    submitBtn.textContent = originalText;
                    return;
                }

                const driverData = {
                    driverNumber: document.getElementById('driverNumber').value,
                    firstName: document.getElementById('firstName').value,
                    lastName: document.getElementById('lastName').value,
                    email: document.getElementById('email').value,
                    phone: document.getElementById('phone').value,
                    status: document.getElementById('status').value,
                    driverType: driverType, // New field
                    currentTruckId: document.getElementById('currentTruckId').value || null, // TRUCK ASSIGNMENT
                    license: {
                        number: document.getElementById('licenseNumber').value,
                        state: document.getElementById('licenseState').value,
                        expiration: document.getElementById('licenseExpiration').value,
                        class: document.getElementById('licenseClass').value,
                        endorsements: document.getElementById('endorsements').value
                    },
                    medicalExpirationDate: document.getElementById('medicalExpirationDate').value,
                    payment: {
                        type: document.getElementById('paymentType').value,
                        perMileRate: document.getElementById('paymentType').value === 'per_mile'
                            ? parseFloat(document.getElementById('ratePerMile').value) || 0
                            : undefined,
                        percentage: document.getElementById('paymentType').value === 'percentage'
                            ? parseFloat(document.getElementById('percentageRate').value) || 0
                            : undefined,
                        flatRate: document.getElementById('paymentType').value === 'flat_rate'
                            ? parseFloat(document.getElementById('ratePerMile').value) || 0
                            : undefined,
                        detention: parseFloat(document.getElementById('detentionPay').value) || 0,
                        layover: parseFloat(document.getElementById('layoverPay').value) || 0,
                        fuelSurcharge: document.getElementById('fuelSurcharge').checked || false
                    },
                    // Store pay percentage separately for easier access
                    payPercentage: document.getElementById('paymentType').value === 'percentage'
                        ? (() => {
                            const percentage = parseFloat(document.getElementById('percentageRate').value) || 0;
                            if (percentage <= 0) {
                                throw new Error('Driver pay percentage is required and must be greater than 0. Each driver must have their own specific percentage.');
                            }
                            return Utils.validatePayPercentage(percentage, driverType);
                        })()
                        : undefined,
                    // Deduction preferences for Owner Operators
                    deductionPreferences: driverType === 'owner_operator' ? {
                        fuel: document.getElementById('deductFuel').checked || false,
                        insurance: document.getElementById('deductInsurance').checked || false,
                        maintenance: document.getElementById('deductMaintenance').checked || false,
                        other: document.getElementById('deductOther').checked || false
                    } : undefined,
                    employment: {
                        hireDate: document.getElementById('hireDate').value,
                        payFrequency: document.getElementById('payFrequency').value
                    }
                };

                console.log('=== DRIVER SAVE DEBUG ===');
                console.log('Driver data to save:', driverData);
                console.log('DataManager.drivers BEFORE:', DataManager.drivers.length);

                const id = document.getElementById('driverId').value;
                if (id) {
                    await DataManager.updateDriver(id, driverData);
                    Utils.logActivity('Driver Updated', `Driver ${driverData.firstName} ${driverData.lastName} updated`, 'driver');
                    console.log('Driver updated, ID:', id);
                } else {
                    const newId = await DataManager.addDriver(driverData);
                    Utils.logActivity('Driver Created', `New driver ${driverData.firstName} ${driverData.lastName} added`, 'driver');
                    console.log('Driver added, new ID:', newId);
                }

                console.log('DataManager.drivers AFTER:', DataManager.drivers.length);

                closeModal();
                console.log('About to render drivers...');
                renderDrivers();
                console.log('Drivers rendered');
                updateDriverStats();
            } catch (error) {
                console.error('Error saving driver:', error);
                alert('Failed to save driver: ' + error.message);
            } finally {
                submitBtn.disabled = false;
                submitBtn.textContent = originalText;
            }
        };

        // Close modal when clicking outside
        window.onclick = function (event) {
            const modal = document.getElementById('driverModal');
            if (event.target === modal) {
                closeModal();
            }
        }
    </script>
</body>

</html>